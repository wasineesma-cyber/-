<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'Segoe UI', Tahoma, sans-serif;
    background: #f0f4f8;
    color: #2d3748;
    min-height: 100vh;
  }

  header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 24px;
    box-shadow: 0 4px 12px rgba(102,126,234,0.4);
  }
  header h1 { font-size: 1.5rem; font-weight: 700; }
  header p { font-size: 0.85rem; opacity: 0.85; margin-top: 2px; }

  .container { max-width: 900px; margin: 0 auto; padding: 20px 16px; }

  /* Summary Cards */
  .summary-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 14px;
    margin-bottom: 20px;
  }
  .card {
    background: white;
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
    text-align: center;
  }
  .card .label { font-size: 0.78rem; color: #718096; margin-bottom: 6px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; }
  .card .amount { font-size: 1.35rem; font-weight: 700; }
  .card.income .amount { color: #38a169; }
  .card.expense .amount { color: #e53e3e; }
  .card.balance .amount { color: #3182ce; }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 8px;
    margin-bottom: 16px;
  }
  .tab-btn {
    flex: 1;
    padding: 10px;
    border: none;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
    color: #718096;
    box-shadow: 0 1px 4px rgba(0,0,0,0.08);
  }
  .tab-btn.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 12px rgba(102,126,234,0.4);
  }

  /* Panels */
  .panel { display: none; }
  .panel.active { display: block; }

  /* Form */
  .form-card {
    background: white;
    border-radius: 14px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }
  .form-card h3 { font-size: 1rem; margin-bottom: 16px; color: #4a5568; }

  .type-toggle {
    display: flex;
    gap: 10px;
    margin-bottom: 16px;
  }
  .type-btn {
    flex: 1;
    padding: 10px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    font-size: 0.9rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    background: white;
  }
  .type-btn.income.active { border-color: #38a169; background: #f0fff4; color: #38a169; }
  .type-btn.expense.active { border-color: #e53e3e; background: #fff5f5; color: #e53e3e; }

  .form-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-bottom: 12px;
  }
  .form-group { display: flex; flex-direction: column; gap: 5px; }
  .form-group.full { grid-column: 1 / -1; }
  .form-group label { font-size: 0.8rem; font-weight: 600; color: #718096; }
  .form-group input, .form-group select, .form-group textarea {
    padding: 9px 12px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.9rem;
    font-family: inherit;
    transition: border-color 0.2s;
    outline: none;
    background: #fafafa;
  }
  .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
    border-color: #667eea;
    background: white;
  }

  .btn-submit {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-weight: 700;
    color: white;
    cursor: pointer;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 12px rgba(102,126,234,0.4);
    transition: opacity 0.2s;
  }
  .btn-submit:hover { opacity: 0.9; }

  /* Charts */
  .charts-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-bottom: 16px;
  }
  .chart-card {
    background: white;
    border-radius: 14px;
    padding: 18px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.07);
  }
  .chart-card h3 { font-size: 0.9rem; font-weight: 700; color: #4a5568; margin-bottom: 12px; }
  .chart-wrap { position: relative; height: 200px; }

  /* Month filter */
  .filter-row {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }
  .filter-row label { font-size: 0.8rem; font-weight: 600; color: #718096; }
  .filter-row input[type="month"] {
    padding: 7px 10px;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    font-size: 0.85rem;
    outline: none;
    font-family: inherit;
  }
  .filter-row input[type="month"]:focus { border-color: #667eea; }

  /* Transaction List */
  .tx-list { display: flex; flex-direction: column; gap: 8px; }
  .tx-item {
    background: white;
    border-radius: 12px;
    padding: 13px 16px;
    box-shadow: 0 1px 6px rgba(0,0,0,0.07);
    display: flex;
    align-items: center;
    gap: 12px;
    transition: transform 0.15s;
  }
  .tx-item:hover { transform: translateX(3px); }
  .tx-icon {
    width: 40px; height: 40px;
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
  }
  .tx-item.income .tx-icon { background: #f0fff4; }
  .tx-item.expense .tx-icon { background: #fff5f5; }
  .tx-info { flex: 1; min-width: 0; }
  .tx-info .tx-desc { font-size: 0.9rem; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .tx-info .tx-meta { font-size: 0.75rem; color: #a0aec0; margin-top: 2px; }
  .tx-amount { font-size: 1rem; font-weight: 700; }
  .tx-item.income .tx-amount { color: #38a169; }
  .tx-item.expense .tx-amount { color: #e53e3e; }
  .tx-del {
    background: none; border: none; cursor: pointer;
    color: #cbd5e0; font-size: 1rem; padding: 4px;
    border-radius: 6px; transition: color 0.2s;
  }
  .tx-del:hover { color: #e53e3e; }

  .empty-state {
    text-align: center; padding: 40px 20px;
    color: #a0aec0; font-size: 0.9rem;
  }
  .empty-state .icon { font-size: 2.5rem; margin-bottom: 10px; }

  /* Toast */
  .toast {
    position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: #2d3748; color: white;
    padding: 10px 20px; border-radius: 20px;
    font-size: 0.85rem; font-weight: 600;
    transition: transform 0.3s ease;
    z-index: 1000;
    white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  @media (max-width: 580px) {
    .summary-grid { grid-template-columns: 1fr; }
    .form-grid { grid-template-columns: 1fr; }
    .charts-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>

<header>
  <h1>üí∞ ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</h1>
  <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÜ</p>
</header>

<div class="container">

  <!-- Summary Cards -->
  <div class="summary-grid">
    <div class="card income">
      <div class="label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
      <div class="amount" id="totalIncome">‡∏ø0</div>
    </div>
    <div class="card expense">
      <div class="label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
      <div class="amount" id="totalExpense">‡∏ø0</div>
    </div>
    <div class="card balance">
      <div class="label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ)</div>
      <div class="amount" id="totalBalance">‡∏ø0</div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('add')">‚ûï ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    <button class="tab-btn" onclick="switchTab('chart')">üìä ‡∏Å‡∏£‡∏≤‡∏ü</button>
    <button class="tab-btn" onclick="switchTab('history')">üìã ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</button>
  </div>

  <!-- Panel: Add Entry -->
  <div class="panel active" id="panel-add">
    <div class="form-card">
      <h3>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</h3>
      <div class="type-toggle">
        <button class="type-btn income active" id="btnIncome" onclick="setType('income')">üíö ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
        <button class="type-btn expense" id="btnExpense" onclick="setType('expense')">‚ù§Ô∏è ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
      </div>
      <div class="form-grid">
        <div class="form-group">
          <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)</label>
          <input type="number" id="inputAmount" placeholder="0.00" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
          <input type="date" id="inputDate">
        </div>
        <div class="form-group">
          <label>‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
          <select id="inputCategory"></select>
        </div>
        <div class="form-group">
          <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
          <input type="text" id="inputDesc" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô">
        </div>
      </div>
      <button class="btn-submit" onclick="addEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
    </div>
  </div>

  <!-- Panel: Charts -->
  <div class="panel" id="panel-chart">
    <div class="charts-grid">
      <div class="chart-card" style="grid-column: 1 / -1;">
        <h3>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö-‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</h3>
        <div class="chart-wrap"><canvas id="chartBar"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
        <div class="chart-wrap"><canvas id="chartPie"></canvas></div>
      </div>
      <div class="chart-card">
        <h3>‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</h3>
        <div class="chart-wrap"><canvas id="chartPieIncome"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Panel: History -->
  <div class="panel" id="panel-history">
    <div class="filter-row">
      <label>‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
      <input type="month" id="filterMonth" onchange="renderHistory()">
      <label style="margin-left:10px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
      <select id="filterType" onchange="renderHistory()" style="padding:7px 10px;border:2px solid #e2e8f0;border-radius:8px;font-size:0.85rem;outline:none;font-family:inherit;">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
        <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
      </select>
    </div>
    <div class="tx-list" id="txList"></div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
// ---- Data ----
const INCOME_CATS = ['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô','‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à','‡∏•‡∏á‡∏ó‡∏∏‡∏ô','‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå','‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç','‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏±‡∏ö)'];
const EXPENSE_CATS = ['‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á','‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å','‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ','‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°','‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á','‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á','‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤','‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
const CAT_ICONS = {
  '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô':'üíº','‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à':'üè¢','‡∏•‡∏á‡∏ó‡∏∏‡∏ô':'üìà','‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå':'üíª','‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç':'üéÅ','‡∏≠‡∏∑‡πà‡∏ô‡πÜ (‡∏£‡∏±‡∏ö)':'üí∞',
  '‡∏≠‡∏≤‡∏´‡∏≤‡∏£':'üçú','‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á':'üöå','‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å':'üè†','‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ':'üí°','‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û':'üíä','‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°':'üíÑ',
  '‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á':'üéÆ','‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á':'üõçÔ∏è','‡∏Å‡∏≤‡∏£‡∏®‡∏∂‡∏Å‡∏©‡∏≤':'üìö','‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô':'üõ°Ô∏è','‡∏≠‡∏∑‡πà‡∏ô‡πÜ':'üì¶'
};
const PIE_COLORS = [
  '#667eea','#f6ad55','#68d391','#fc8181','#63b3ed','#b794f4',
  '#fbb6ce','#76e4f7','#faf089','#9ae6b4','#feb2b2','#c3dafe'
];

let currentType = 'income';
let entries = JSON.parse(localStorage.getItem('expense_entries') || '[]');
let chartBar, chartPie, chartPieIncome;

// ---- Init ----
function init() {
  const today = new Date();
  document.getElementById('inputDate').value = today.toISOString().slice(0, 10);
  document.getElementById('filterMonth').value = today.toISOString().slice(0, 7);
  setType('income');
  updateSummary();
  renderHistory();
}

// ---- Type Toggle ----
function setType(type) {
  currentType = type;
  document.getElementById('btnIncome').classList.toggle('active', type === 'income');
  document.getElementById('btnExpense').classList.toggle('active', type === 'expense');
  const cats = type === 'income' ? INCOME_CATS : EXPENSE_CATS;
  const sel = document.getElementById('inputCategory');
  sel.innerHTML = cats.map(c => `<option value="${c}">${CAT_ICONS[c] || ''} ${c}</option>`).join('');
}

// ---- Add Entry ----
function addEntry() {
  const amount = parseFloat(document.getElementById('inputAmount').value);
  const date = document.getElementById('inputDate').value;
  const category = document.getElementById('inputCategory').value;
  const desc = document.getElementById('inputDesc').value.trim() || category;

  if (!amount || amount <= 0) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô'); return; }
  if (!date) { showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'); return; }

  entries.push({ id: Date.now(), type: currentType, amount, date, category, desc });
  save();
  updateSummary();
  renderHistory();
  if (chartBar) renderCharts();

  document.getElementById('inputAmount').value = '';
  document.getElementById('inputDesc').value = '';
  showToast(currentType === 'income' ? '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß' : '‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
}

// ---- Delete ----
function deleteEntry(id) {
  entries = entries.filter(e => e.id !== id);
  save();
  updateSummary();
  renderHistory();
  if (chartBar) renderCharts();
  showToast('üóëÔ∏è ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß');
}

// ---- Summary ----
function updateSummary() {
  const now = new Date();
  const ym = now.toISOString().slice(0, 7);
  const monthly = entries.filter(e => e.date.startsWith(ym));
  const income = monthly.filter(e => e.type === 'income').reduce((s, e) => s + e.amount, 0);
  const expense = monthly.filter(e => e.type === 'expense').reduce((s, e) => s + e.amount, 0);
  const balance = income - expense;

  document.getElementById('totalIncome').textContent = '‡∏ø' + fmt(income);
  document.getElementById('totalExpense').textContent = '‡∏ø' + fmt(expense);
  const el = document.getElementById('totalBalance');
  el.textContent = '‡∏ø' + fmt(Math.abs(balance));
  el.style.color = balance >= 0 ? '#3182ce' : '#e53e3e';
  if (balance < 0) el.textContent = '-‡∏ø' + fmt(Math.abs(balance));
}

// ---- History ----
function renderHistory() {
  const ym = document.getElementById('filterMonth').value;
  const ft = document.getElementById('filterType').value;
  let data = entries.filter(e => e.date.startsWith(ym));
  if (ft !== 'all') data = data.filter(e => e.type === ft);
  data.sort((a, b) => b.date.localeCompare(a.date) || b.id - a.id);

  const container = document.getElementById('txList');
  if (data.length === 0) {
    container.innerHTML = `<div class="empty-state"><div class="icon">üì≠</div>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>`;
    return;
  }
  container.innerHTML = data.map(e => `
    <div class="tx-item ${e.type}">
      <div class="tx-icon">${CAT_ICONS[e.category] || 'üí∞'}</div>
      <div class="tx-info">
        <div class="tx-desc">${esc(e.desc)}</div>
        <div class="tx-meta">${e.category} ¬∑ ${formatDate(e.date)}</div>
      </div>
      <div class="tx-amount">${e.type === 'income' ? '+' : '-'}‡∏ø${fmt(e.amount)}</div>
      <button class="tx-del" onclick="deleteEntry(${e.id})" title="‡∏•‡∏ö">üóëÔ∏è</button>
    </div>
  `).join('');
}

// ---- Charts ----
function renderCharts() {
  renderBarChart();
  renderPieChart();
  renderPieIncomeChart();
}

function renderBarChart() {
  // Last 6 months
  const months = [];
  const now = new Date();
  for (let i = 5; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toISOString().slice(0, 7));
  }
  const labels = months.map(m => {
    const [y, mo] = m.split('-');
    const thMonth = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
    return thMonth[parseInt(mo)-1] + ' ' + (parseInt(y)+543);
  });
  const incomes = months.map(m => entries.filter(e => e.type==='income' && e.date.startsWith(m)).reduce((s,e)=>s+e.amount,0));
  const expenses = months.map(m => entries.filter(e => e.type==='expense' && e.date.startsWith(m)).reduce((s,e)=>s+e.amount,0));

  if (chartBar) chartBar.destroy();
  chartBar = new Chart(document.getElementById('chartBar'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö', data: incomes, backgroundColor: 'rgba(56,161,105,0.7)', borderRadius: 6 },
        { label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢', data: expenses, backgroundColor: 'rgba(229,62,62,0.7)', borderRadius: 6 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { position: 'top' }, tooltip: { callbacks: { label: ctx => ' ‡∏ø' + fmt(ctx.raw) } } },
      scales: { y: { ticks: { callback: v => '‡∏ø' + fmt(v) } } }
    }
  });
}

function renderPieChart() {
  const ym = new Date().toISOString().slice(0, 7);
  const expEntries = entries.filter(e => e.type === 'expense' && e.date.startsWith(ym));
  const catMap = {};
  expEntries.forEach(e => { catMap[e.category] = (catMap[e.category] || 0) + e.amount; });
  const cats = Object.keys(catMap);

  if (chartPie) chartPie.destroy();
  if (cats.length === 0) {
    chartPie = null;
    return;
  }
  chartPie = new Chart(document.getElementById('chartPie'), {
    type: 'doughnut',
    data: {
      labels: cats,
      datasets: [{ data: cats.map(c => catMap[c]), backgroundColor: PIE_COLORS.slice(0, cats.length), borderWidth: 2 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 }, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.label + ': ‡∏ø' + fmt(ctx.raw) } }
      }
    }
  });
}

function renderPieIncomeChart() {
  const ym = new Date().toISOString().slice(0, 7);
  const incEntries = entries.filter(e => e.type === 'income' && e.date.startsWith(ym));
  const catMap = {};
  incEntries.forEach(e => { catMap[e.category] = (catMap[e.category] || 0) + e.amount; });
  const cats = Object.keys(catMap);

  if (chartPieIncome) chartPieIncome.destroy();
  if (cats.length === 0) { chartPieIncome = null; return; }
  chartPieIncome = new Chart(document.getElementById('chartPieIncome'), {
    type: 'doughnut',
    data: {
      labels: cats,
      datasets: [{ data: cats.map(c => catMap[c]), backgroundColor: ['#667eea','#9ae6b4','#fbb6ce','#63b3ed','#f6ad55','#b794f4'], borderWidth: 2 }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { position: 'right', labels: { font: { size: 11 }, boxWidth: 12 } },
        tooltip: { callbacks: { label: ctx => ctx.label + ': ‡∏ø' + fmt(ctx.raw) } }
      }
    }
  });
}

// ---- Tabs ----
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach((b, i) => {
    b.classList.toggle('active', ['add','chart','history'][i] === tab);
  });
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  if (tab === 'chart') renderCharts();
}

// ---- Helpers ----
function save() { localStorage.setItem('expense_entries', JSON.stringify(entries)); }
function fmt(n) { return Number(n).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function formatDate(d) {
  const [y, m, day] = d.split('-');
  const thMonth = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
  return parseInt(day) + ' ' + thMonth[parseInt(m)-1] + ' ' + (parseInt(y)+543);
}
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}

init();
</script>
</body>
</html>
