<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Don Note">
<meta name="theme-color" content="#FF4785">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<title>ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</title>
<style>
:root {
  --pink: #FF4785;
  --pink-light: #FFF0F5;
  --bg: #F5F5F5;
  --white: #FFFFFF;
  --text: #1C1C1E;
  --sub: #8E8E93;
  --border: #E5E5EA;
  --nav-h: 75px; /* ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á‡πÄ‡∏°‡∏ô‡∏π‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏á‡πà‡∏≤‡∏¢ */
}

* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { 
  font-family: -apple-system, sans-serif; 
  background: var(--bg); 
  color: var(--text);
  padding-bottom: var(--nav-h); /* ‡∏Å‡∏±‡∏ô‡πÄ‡∏°‡∏ô‡∏π‡∏ö‡∏±‡∏á‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤ */
}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header {
  background: var(--white);
  padding: 15px;
  padding-top: calc(15px + env(safe-area-inset-top));
  text-align: center;
  font-weight: 800;
  border-bottom: 1px solid var(--border);
}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel { display: none; padding: 20px; max-width: 500px; margin: 0 auto; }
.panel.active { display: block; }

/* ‚îÄ‚îÄ BOTTOM NAV (‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô) ‚îÄ‚îÄ */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 0; right: 0;
  height: var(--nav-h);
  background: var(--white);
  border-top: 1px solid var(--border);
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  padding-bottom: env(safe-area-inset-bottom);
  z-index: 1000;
  box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
}

.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: none;
  border: none;
  color: var(--sub);
  gap: 4px;
  cursor: pointer;
}

.nav-btn span { font-size: 26px; } /* ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡∏±‡∏î */
.nav-btn label { font-size: 11px; font-weight: 700; cursor: pointer; }
.nav-btn.active { color: var(--pink); }

/* ‚îÄ‚îÄ UI ELEMENTS ‚îÄ‚îÄ */
.card { background: var(--white); border-radius: 20px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
.balance-amt { font-size: 2.5rem; font-weight: 900; text-align: center; margin: 10px 0; }
.btn-main { 
  width: 100%; padding: 15px; border-radius: 15px; border: none; 
  background: var(--pink); color: white; font-size: 1rem; font-weight: 800; 
}
input, select { 
  width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--border); 
  margin-bottom: 10px; font-size: 1rem; 
}

/* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
#splash {
  position: fixed; inset: 0; z-index: 9999; background: var(--pink);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  transition: opacity 0.5s;
}
#splash.hide { opacity: 0; pointer-events: none; }
</style>
</head>
<body>

<div id="splash">
  <div style="font-size:70px;">üêº</div>
  <div style="color:white; font-size:1.5rem; font-weight:800; margin-top:10px;">Don Note</div>
</div>

<div class="header">Îèà‡πÇ‡∏ô‡πâ‡∏ï Don Note ‚≠ê</div>

<div class="panel active" id="panel-home">
  <div class="card" style="text-align:center;">
    <div style="color:var(--sub); font-size:0.8rem; font-weight:700;">‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</div>
    <div class="balance-amt" id="balAmount">‡∏ø0</div>
  </div>
  
  <div class="card">
    <div style="margin-bottom:10px; font-weight:700;">‚ö° ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏î‡πà‡∏ß‡∏ô</div>
    <div style="display:flex; gap:8px;">
      <input id="chatIn" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏≤‡πÅ‡∏ü 60" style="margin:0;">
      <button onclick="parseChat()" style="background:var(--pink); color:white; border:none; padding:0 15px; border-radius:12px;">‡∏™‡πà‡∏á</button>
    </div>
  </div>
</div>

<div class="panel" id="panel-add">
  <h3 style="margin-bottom:15px; text-align:center;">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h3>
  <select id="addType">
    <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ (-)</option>
    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö (+)</option>
  </select>
  <input type="number" id="inputAmt" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)">
  <input type="text" id="noteField" placeholder="‡∏à‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡∏´‡∏ô‡πà‡∏≠‡∏¢...">
  <button class="btn-main" onclick="addEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</div>

<div class="panel" id="panel-budget">
  <h3 style="margin-bottom:15px; text-align:center;">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</h3>
  <div class="card">
    <label style="font-size:0.8rem; font-weight:700; color:var(--sub);">‡∏£‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏¢‡∏≠‡∏î</label>
    <select id="cycleType" onchange="saveCycleSettings()">
      <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</option>
      <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏ó‡∏∏‡∏Å 7 ‡∏ß‡∏±‡∏ô)</option>
    </select>
  </div>
</div>

<div class="panel" id="panel-history">
  <h3 style="margin-bottom:15px; text-align:center;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢</h3>
  <div id="txList"></div>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="goPanel('panel-home', this)">
    <span>üè†</span>
    <label>‡∏™‡∏£‡∏∏‡∏õ</label>
  </button>
  <button class="nav-btn" onclick="goPanel('panel-add', this)">
    <span>‚úèÔ∏è</span>
    <label>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</label>
  </button>
  <button class="nav-btn" onclick="goPanel('panel-budget', this)">
    <span>‚öôÔ∏è</span>
    <label>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</label>
  </button>
  <button class="nav-btn" onclick="goPanel('panel-history', this)">
    <span>üìã</span>
    <label>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label>
  </button>
</nav>

<script>
// --- CONFIG --- (‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ Config ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
const firebaseConfig = {
  apiKey: "AIzaSyAOAr6OsQpf_e-xv8qfLyIUu6Dant1MkS4",
  authDomain: "don-note.firebaseapp.com",
  projectId: "don-note",
  storageBucket: "don-note.firebasestorage.app",
  messagingSenderId: "661381674055",
  appId: "1:661381674055:web:0427dc17348fb11b56ed62"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const LIFF_ID = '2009230946-hp9vcPh3';

let userId = "guest";
let entries = [];
let cycle = "monthly";

async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      const profile = await liff.getProfile();
      userId = profile.userId;
    }
    await loadData();
    renderAll();
  } catch (e) { console.error(e); }
  document.getElementById('splash').classList.add('hide');
}

async function loadData() {
  const doc = await db.collection('dongNote').doc(userId).get();
  if (doc.exists) {
    const data = doc.data();
    entries = data.entries || [];
    cycle = data.settings?.cycle || "monthly";
    document.getElementById('cycleType').value = cycle;
  }
}

async function saveData() {
  await db.collection('dongNote').doc(userId).set({
    entries, settings: { cycle }
  }, { merge: true });
}

function goPanel(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  if(id === 'panel-history') renderHistory();
}

function renderAll() {
  const totalInc = entries.filter(e => e.type === 'income').reduce((s, e) => s + e.amount, 0);
  const totalExp = entries.filter(e => e.type === 'expense').reduce((s, e) => s + e.amount, 0);
  document.getElementById('balAmount').textContent = '‡∏ø' + (totalInc - totalExp).toLocaleString();
}

async function addEntry() {
  const amt = parseFloat(document.getElementById('inputAmt').value);
  const note = document.getElementById('noteField').value;
  const type = document.getElementById('addType').value;
  
  if(!amt) return alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");

  entries.push({
    id: Date.now(),
    type: type,
    amount: amt,
    note: note || (type === 'expense' ? "‡∏à‡πà‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å" : "‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤"),
    date: new Date().toISOString().slice(0, 10)
  });

  await saveData();
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  document.getElementById('inputAmt').value = '';
  document.getElementById('noteField').value = '';
  goPanel('panel-home', document.querySelector('.nav-btn'));
  renderAll();
}

function parseChat() {
  const val = document.getElementById('chatIn').value;
  const amt = parseFloat(val.match(/\d+/));
  if (amt) {
    document.getElementById('inputAmt').value = amt;
    document.getElementById('noteField').value = val.replace(/\d+/, '').trim();
    addEntry();
    document.getElementById('chatIn').value = '';
  }
}

function renderHistory() {
  const list = document.getElementById('txList');
  list.innerHTML = entries.slice().reverse().map(e => `
    <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div style="font-weight:700;">${e.note}</div>
        <div style="font-size:0.7rem; color:var(--sub);">${e.date}</div>
      </div>
      <div style="font-weight:900; color:${e.type==='expense'?'var(--pink)':'#00C9A7'}">
        ${e.type==='expense'?'-':'+'}‡∏ø${e.amount.toLocaleString()}
      </div>
    </div>
  `).join('') || '<p style="text-align:center; color:var(--sub);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>';
}

async function saveCycleSettings() {
  cycle = document.getElementById('cycleType').value;
  await saveData();
  alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß");
}

init();
</script>
</body>
</html>
