<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#ffffff">
<title>ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</title>
<style>
:root {
  --pink:       #FF4785;
  --pink-light: #FFF0F5;
  --pink-border:#FFADD2;
  --pink-track: #FFD6E7;
  --teal:       #00C9A7;
  --teal-light: #E8FAF7;
  --teal-border:#80E5D8;
  --teal-track: #B2F0E8;
  --bg:         #F5F5F5;
  --white:      #FFFFFF;
  --text:       #1C1C1E;
  --sub:        #8E8E93;
  --border:     #E5E5EA;
  --nav-h:      60px;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Text','Segoe UI',sans-serif;}
body{padding-bottom:var(--nav-h);}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{
  background:var(--white);
  padding:12px 18px;
  padding-top:calc(12px + env(safe-area-inset-top));
  display:flex;align-items:center;justify-content:center;
  position:relative;
}
.header-title{font-size:1rem;font-weight:700;color:var(--text);}
.header-bear{
  position:absolute;left:16px;
  font-size:1.3rem;cursor:pointer;
}
.header-right{position:absolute;right:16px;font-size:.8rem;color:var(--sub);}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  height:var(--nav-h);
  background:var(--white);
  border-top:1px solid var(--border);
  display:grid;grid-template-columns:repeat(5,1fr);
  padding-bottom:env(safe-area-inset-bottom);
  z-index:100;
}
.nav-btn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;background:none;border:none;cursor:pointer;
  color:var(--sub);font-size:.58rem;font-weight:600;letter-spacing:.02em;
  transition:color .2s;
}
.nav-btn .ni{font-size:1.3rem;}
.nav-btn.active{color:var(--pink);}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{display:none;max-width:480px;margin:0 auto;padding:14px 14px;}
.panel.active{display:block;}

/* ‚îÄ‚îÄ ‡∏™‡∏£‡∏∏‡∏õ PANEL ‚îÄ‚îÄ */

/* Period pill */
.period-pill{
  display:flex;align-items:center;justify-content:center;
  gap:6px;margin:0 auto 14px;
  background:var(--white);border:1px solid var(--border);
  border-radius:20px;padding:8px 18px;
  font-size:.85rem;font-weight:600;color:var(--text);
  width:fit-content;cursor:pointer;
}
.period-pill .pi-arrow{color:var(--sub);font-size:.7rem;}

/* Balance */
.balance-wrap{text-align:center;margin-bottom:14px;}
.balance-label{font-size:.72rem;color:var(--sub);font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
.balance-amount{font-size:2.6rem;font-weight:900;margin:4px 0 8px;color:#1C1C1E;}
.balance-amount.positive{color:#34C759;}
.balance-amount.negative{color:var(--pink);}
.period-btn{
  display:inline-flex;align-items:center;gap:5px;
  border:1px solid var(--border);border-radius:20px;
  padding:6px 14px;font-size:.78rem;font-weight:600;color:var(--text);
  background:var(--white);cursor:pointer;
}

/* Inc/Exp cards */
.ie-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.ie-card{
  padding:14px 14px;border-radius:16px;border:2px solid var(--border);
  background:var(--white);cursor:pointer;transition:border-color .2s;
}
.ie-card.exp-card{background:var(--pink-light);}
.ie-card.inc-card{background:var(--teal-light);}
.ie-card.active.exp-card{border-color:var(--pink);}
.ie-card.active.inc-card{border-color:var(--teal);}
.ie-card .iec-label{font-size:.72rem;font-weight:700;margin-bottom:5px;}
.ie-card.exp-card .iec-label{color:var(--pink);}
.ie-card.inc-card .iec-label{color:var(--teal);}
.ie-card .iec-amount{font-size:1.25rem;font-weight:900;}
.ie-card.exp-card .iec-amount{color:var(--pink);}
.ie-card.inc-card .iec-amount{color:var(--teal);}

/* Summary card */
.sum-card{
  background:var(--white);border-radius:20px;
  padding:18px 16px;
  box-shadow:0 1px 6px rgba(0,0,0,.07);
}
.sum-card-header{
  display:flex;align-items:center;gap:10px;
  margin-bottom:18px;
}
.dong-badge{
  width:44px;height:44px;flex-shrink:0;
  background:radial-gradient(circle,#fff8e7,#fff0d0);
  border:2px solid #F0C040;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.55rem;font-weight:800;color:#C07800;text-align:center;
  line-height:1.2;letter-spacing:.01em;
  box-shadow:0 2px 6px rgba(192,120,0,.2);
}
.sum-card-title{
  flex:1;text-align:center;
  font-size:1.05rem;font-weight:800;
}
.sum-card-title.exp-title{color:var(--pink);}
.sum-card-title.inc-title{color:var(--teal);}

/* Category rows */
.cat-row{margin-bottom:14px;}
.cat-row-top{
  display:flex;justify-content:space-between;align-items:baseline;
  margin-bottom:5px;
}
.cat-row-name{font-size:.92rem;font-weight:600;color:var(--text);}
.cat-row-amt{font-size:.82rem;color:var(--sub);}
.bar-track{height:5px;border-radius:4px;overflow:hidden;}
.bar-track.exp-track{background:var(--pink-track);}
.bar-track.inc-track{background:var(--teal-track);}
.bar-fill{height:100%;border-radius:4px;transition:width .9s ease;}
.bar-fill.exp-fill{background:var(--pink);}

/* Manage budget btn */
.btn-manage{
  width:100%;padding:13px;margin-top:10px;
  background:var(--white);border:1px solid var(--border);
  border-radius:12px;font-size:.88rem;font-weight:600;
  color:var(--text);cursor:pointer;transition:background .2s;
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.btn-manage:hover{background:var(--bg);}

/* Invite banner */
.invite-banner{
  width:100%;padding:14px;margin-top:10px;
  background:linear-gradient(135deg,var(--pink),#FF7BB5);
  border:none;border-radius:14px;font-size:.88rem;font-weight:800;
  color:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.invite-badge{
  background:#FFD700;color:#8B6914;font-size:.62rem;font-weight:900;
  padding:3px 8px;border-radius:12px;white-space:nowrap;
}

/* ‚îÄ‚îÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PANEL ‚îÄ‚îÄ */
.add-header{text-align:center;font-size:1rem;font-weight:700;padding:4px 0 14px;}

.type-tabs{
  display:grid;grid-template-columns:1fr 1fr;gap:0;
  background:var(--bg);border-radius:12px;padding:3px;
  margin-bottom:16px;
}
.type-tab{
  padding:10px;border:none;border-radius:10px;
  font-size:.88rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.type-tab.active.exp{background:var(--white);color:var(--pink);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.type-tab.active.inc{background:var(--white);color:var(--teal);box-shadow:0 1px 4px rgba(0,0,0,.1);}

.amount-box{
  background:var(--bg);border-radius:16px;padding:16px 18px;
  margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.amount-box .curr{font-size:1.4rem;font-weight:800;color:var(--sub);}
.amount-box input{
  flex:1;border:none;background:transparent;outline:none;
  font-size:2rem;font-weight:900;color:var(--text);font-family:inherit;
}
.amount-box input::placeholder{color:#C7C7CC;}

.quick-row{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
.q-chip{
  padding:7px 16px;border-radius:20px;
  border:1px solid var(--border);background:var(--white);
  font-size:.82rem;font-weight:600;color:var(--text);cursor:pointer;
  transition:all .2s;
}
.q-chip:hover,.q-chip.sel{background:var(--pink);border-color:var(--pink);color:#fff;}
.q-chip.sel.inc-chip{background:var(--teal);border-color:var(--teal);}

.form-label{font-size:.7rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.cat-grid2{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
.cat-chip2{
  padding:10px 4px;border-radius:14px;border:2px solid var(--border);
  background:var(--white);cursor:pointer;text-align:center;
  transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px;
}
.cat-chip2 .cc2-icon{font-size:1.25rem;}
.cat-chip2 .cc2-name{font-size:.6rem;font-weight:600;color:var(--sub);}
.cat-chip2.sel.exp-sel{border-color:var(--pink);background:var(--pink-light);}
.cat-chip2.sel.exp-sel .cc2-name{color:var(--pink);}
.cat-chip2.sel.inc-sel{border-color:var(--teal);background:var(--teal-light);}
.cat-chip2.sel.inc-sel .cc2-name{color:var(--teal);}

.note-field{
  width:100%;padding:12px 14px;
  border:1px solid var(--border);border-radius:12px;
  font-size:.9rem;font-family:inherit;outline:none;
  background:var(--white);color:var(--text);margin-bottom:14px;
  transition:border-color .2s;
}
.note-field:focus{border-color:var(--pink);}

.btn-add{
  width:100%;padding:14px;border:none;border-radius:14px;
  font-size:1rem;font-weight:800;color:#fff;cursor:pointer;
  transition:opacity .2s;letter-spacing:.02em;
}
.btn-add.exp-btn{background:var(--pink);box-shadow:0 4px 14px rgba(255,71,133,.3);}
.btn-add.inc-btn{background:var(--teal);box-shadow:0 4px 14px rgba(0,201,167,.3);}
.btn-add:active{transform:scale(.98);}

/* ‚îÄ‚îÄ ‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö PANEL ‚îÄ‚îÄ */
.budget-header{font-size:1.1rem;font-weight:800;text-align:center;margin-bottom:14px;}
.period-setting-card{
  background:var(--white);border-radius:16px;padding:14px 16px;
  margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.05);
}
.psc-left .psc-title{font-size:.8rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.05em;}
.psc-left .psc-val{font-size:.9rem;font-weight:600;margin-top:3px;display:flex;align-items:center;gap:5px;}
.btn-small{
  padding:7px 14px;border-radius:10px;border:1px solid var(--border);
  background:var(--white);font-size:.78rem;font-weight:600;cursor:pointer;
  display:flex;align-items:center;gap:4px;
}
.budget-type-tabs{
  display:grid;grid-template-columns:1fr 1fr;gap:0;
  background:var(--bg);border-radius:12px;padding:3px;
  margin-bottom:12px;
}
.btt{
  padding:10px;border:none;border-radius:10px;
  font-size:.88rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.btt.active.exp{background:var(--white);color:var(--pink);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.btt.active.inc{background:var(--white);color:var(--teal);box-shadow:0 1px 4px rgba(0,0,0,.1);}

.budget-list{display:flex;flex-direction:column;gap:8px;}
.budget-item{
  background:var(--white);border-radius:14px;padding:14px 16px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.05);cursor:pointer;
  transition:background .2s;
}
.budget-item:hover{background:#fafafa;}
.bi-name{font-size:.92rem;font-weight:600;}
.bi-right{display:flex;align-items:center;gap:8px;}
.bi-budget{font-size:.8rem;color:var(--sub);}
.bi-arrow{color:var(--sub);font-size:.8rem;}

/* Budget modal */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:500;padding:0 0 env(safe-area-inset-bottom);
}
.overlay.hidden{display:none;}
.sheet{
  background:var(--white);border-radius:24px 24px 0 0;
  width:100%;max-width:480px;padding:20px 20px 28px;
}
.sheet-handle{
  width:40px;height:4px;border-radius:2px;
  background:var(--border);margin:0 auto 16px;
}
.sheet-title{font-size:1rem;font-weight:700;margin-bottom:16px;}
.sheet-input{
  width:100%;padding:12px 14px;border:1px solid var(--border);
  border-radius:12px;font-size:1rem;font-family:inherit;
  outline:none;margin-bottom:12px;
  background:var(--bg);color:var(--text);
  transition:border-color .2s;
}
.sheet-input:focus{border-color:var(--pink);}
.sheet-btns{display:flex;gap:10px;}
.sheet-btns button{flex:1;padding:12px;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;}
.btn-sheet-save{background:var(--pink);color:#fff;}
.btn-sheet-save.inc-save{background:var(--teal);}
.btn-sheet-cancel{background:var(--bg);color:var(--sub);}

/* ‚îÄ‚îÄ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PANEL ‚îÄ‚îÄ */
.filter-row2{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
.filter-row2 select,.filter-row2 input[type="month"]{
  padding:8px 12px;border:1px solid var(--border);border-radius:10px;
  font-size:.83rem;background:var(--white);color:var(--text);
  outline:none;font-family:inherit;
}
.tx-list2{display:flex;flex-direction:column;gap:8px;}
.tx2{
  background:var(--white);border-radius:14px;padding:13px 14px;
  display:flex;align-items:center;gap:11px;
  box-shadow:0 1px 4px rgba(0,0,0,.05);
}
.tx2-icon{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.tx2.expense .tx2-icon{background:var(--pink-light);}
.tx2.income  .tx2-icon{background:var(--teal-light);}
.tx2-info{flex:1;min-width:0;}
.tx2-desc{font-size:.88rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx2-meta{font-size:.7rem;color:var(--sub);margin-top:2px;}
.tx2-amt{font-size:.92rem;font-weight:800;flex-shrink:0;}
.tx2.expense .tx2-amt{color:var(--pink);}
.tx2.income  .tx2-amt{color:var(--teal);}
.tx2-del{background:none;border:none;cursor:pointer;color:#DDD;font-size:.9rem;padding:4px;border-radius:6px;transition:color .2s;}
.tx2-del:hover{color:var(--pink);}
.empty2{text-align:center;padding:40px 20px;color:var(--sub);font-size:.9rem;}

/* ‚îÄ‚îÄ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PANEL ‚îÄ‚îÄ */
.settings-card{background:var(--white);border-radius:16px;margin-bottom:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);}
.settings-card .sc-title{font-size:.7rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.06em;padding:12px 16px 4px;}
.si2{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .2s;
}
.si2:last-child{border-bottom:none;}
.si2:hover{background:#fafafa;}
.si2-left .si2-label{font-size:.9rem;font-weight:600;}
.si2-left .si2-sub  {font-size:.72rem;color:var(--sub);margin-top:2px;}
.si2-right{color:var(--sub);font-size:.85rem;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:calc(var(--nav-h)+16px);left:50%;
  transform:translateX(-50%) translateY(16px);
  background:#1C1C1E;color:#fff;
  padding:10px 20px;border-radius:20px;
  font-size:.85rem;font-weight:600;
  opacity:0;transition:all .3s;z-index:600;
  white-space:nowrap;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ RUNNING DONG ‚îÄ‚îÄ */
#dong-run{
  position:fixed;bottom:calc(var(--nav-h)+8px);left:-70px;
  font-size:2rem;animation:dong-run 16s linear infinite;
  cursor:pointer;z-index:40;pointer-events:auto;
}
@keyframes dong-run{from{left:-70px}to{left:110%}}

/* ‚îÄ‚îÄ HOME BEAR ‚îÄ‚îÄ */
.home-bear-wrap{text-align:center;margin:4px 0 10px;font-size:2.5rem;cursor:pointer;}

/* ‚îÄ‚îÄ CHAT BOX (home) ‚îÄ‚îÄ */
.chat-box{
  background:var(--white);border-radius:16px;padding:14px;
  box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:14px;
}

/* ‚îÄ‚îÄ PIE CHART ‚îÄ‚îÄ */
.pie-section{
  background:var(--white);border-radius:20px;
  padding:16px 16px 14px;margin-bottom:14px;
  box-shadow:0 1px 6px rgba(0,0,0,.07);text-align:center;
}
.pie-filter-row{
  display:flex;gap:4px;justify-content:center;
  margin-bottom:14px;background:var(--bg);
  border-radius:10px;padding:3px;
}
.pie-tab{
  flex:1;padding:8px 12px;border:none;border-radius:8px;
  font-size:.82rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.pie-tab.active{background:var(--white);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.pie-legend{display:flex;justify-content:center;gap:18px;margin-top:12px;flex-wrap:wrap;}
.pie-legend-item{display:flex;align-items:center;gap:5px;font-size:.78rem;font-weight:600;}
.pie-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0;}

/* ‚îÄ‚îÄ API KEY MODAL ‚îÄ‚îÄ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:600;padding:0 0 env(safe-area-inset-bottom);
}
.modal-overlay.hidden{display:none;}
.modal-sheet{
  background:var(--white);border-radius:24px 24px 0 0;
  width:100%;max-width:480px;padding:20px 20px 28px;
}
.modal-sheet h3{font-size:1rem;font-weight:700;margin-bottom:6px;}
.modal-sheet p{font-size:.78rem;color:var(--sub);margin-bottom:14px;line-height:1.5;}
.modal-btns2{display:flex;gap:10px;margin-top:4px;}
.modal-btns2 button{flex:1;padding:12px;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;}
.btn-ms-save{background:var(--pink);color:#fff;}
.btn-ms-cancel{background:var(--bg);color:var(--sub);}
</style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-bear" id="headerBear">üêª</div>
  <div class="header-title">ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</div>
  <div class="header-right" id="headerRight"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏™‡∏£‡∏∏‡∏õ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel-home">

  <div class="balance-wrap">
    <div class="balance-label">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö</div>
    <div class="balance-amount" id="balAmount">‡∏ø0</div>
    <button class="period-btn" onclick="cyclePeriod()">
      <span id="periodLabel">‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡∏ô‡∏µ‡πâ</span>
      <span>‚áÑ</span>
    </button>
  </div>

  <!-- Bear center home -->
  <div class="home-bear-wrap" id="homeBear" onclick="runDong()">üêª</div>

  <!-- Quick type box (moved here from ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å panel) -->
  <div class="chat-box">
    <div class="form-label" style="margin-bottom:8px;">‚ö° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡∏≤‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å 65"</div>
    <div style="display:flex;gap:8px;">
      <input class="note-field" id="chatIn" placeholder="‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß 80 / ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 25000" style="margin:0;flex:1;min-width:0;" inputmode="text" autocomplete="off">
      <button onclick="parseChat()" style="padding:0 18px;border:none;border-radius:12px;background:var(--pink);color:#fff;font-weight:700;cursor:pointer;white-space:nowrap;font-size:.88rem;flex-shrink:0;">‚û§</button>
    </div>
  </div>

  <div class="ie-grid">
    <div class="ie-card exp-card active" id="ieExp" onclick="switchSumTab('expense')">
      <div class="iec-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div class="iec-amount" id="ieExpAmt">‡∏ø0.00</div>
    </div>
    <div class="ie-card inc-card" id="ieInc" onclick="switchSumTab('income')">
      <div class="iec-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
      <div class="iec-amount" id="ieIncAmt">‡∏ø0.00</div>
    </div>
  </div>

  <!-- Pie chart -->
  <div class="pie-section">
    <div class="pie-filter-row">
      <button class="pie-tab active" id="pieTabDay"   onclick="setPiePeriod('day')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button class="pie-tab"        id="pieTabMonth" onclick="setPiePeriod('month')">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <canvas id="pieChart" width="180" height="180" style="max-width:180px;"></canvas>
    <div class="pie-legend" id="pieLegend"></div>
  </div>

  <div class="sum-card">
    <div class="sum-card-header">
      <div class="dong-badge">Don<br>Note</div>
      <div class="sum-card-title exp-title" id="sumCardTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div style="width:44px;"></div>
    </div>
    <div id="catRows"></div>
    <button class="btn-manage" onclick="goPanel('panel-budget')">
      ‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏á‡∏ö
    </button>
    <button class="invite-banner">
      ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô
      <span class="invite-badge">Don Note Pro</span>
      ‡∏£‡∏±‡∏ö‡∏ü‡∏£‡∏µ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    </button>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-add">

  <div class="add-header">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>

  <!-- Type -->
  <div class="type-tabs">
    <button class="type-tab exp active" id="tabExp" onclick="setAddType('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="type-tab inc"        id="tabInc" onclick="setAddType('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
  </div>

  <!-- Amount -->
  <div class="amount-box">
    <span class="curr">‡∏ø</span>
    <input type="number" id="inputAmt" placeholder="0" inputmode="decimal" min="0">
  </div>

  <!-- Quick amounts -->
  <div class="quick-row" id="quickRow">
    <div class="q-chip" onclick="setAmt(30)">30</div>
    <div class="q-chip" onclick="setAmt(50)">50</div>
    <div class="q-chip" onclick="setAmt(65)">65</div>
    <div class="q-chip" onclick="setAmt(100)">100</div>
    <div class="q-chip" onclick="setAmt(200)">200</div>
    <div class="q-chip" onclick="setAmt(500)">500</div>
    <div class="q-chip" onclick="setAmt(1000)">1,000</div>
  </div>

  <!-- Category -->
  <div class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
  <div class="cat-grid2" id="catGrid2"></div>

  <!-- Note -->
  <input class="note-field" id="noteField" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">

  <!-- Submit -->
  <button class="btn-add exp-btn" id="btnAdd" onclick="addEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úì</button>


</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-budget">

  <div class="budget-header">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏á‡∏ö</div>

  <div class="period-setting-card">
    <div class="psc-left">
      <div class="psc-title">‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏î‡∏á‡∏ö</div>
      <div class="psc-val">üìÖ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</div>
    </div>
    <button class="btn-small">‚úèÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  </div>

  <div class="budget-type-tabs">
    <button class="btt exp active" id="bttExp" onclick="switchBudgetTab('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="btt inc"        id="bttInc" onclick="switchBudgetTab('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
  </div>

  <div class="budget-list" id="budgetList"></div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-history">
  <div class="filter-row2">
    <input type="month" id="filterMonth" onchange="renderHistory()">
    <select id="filterType" onchange="renderHistory()">
      <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
      <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
    </select>
  </div>
  <div class="tx-list2" id="txList2"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-settings">
  <div style="text-align:center;padding:20px 0 16px;">
    <div id="settingsBear" style="font-size:3.5rem;cursor:pointer;" onclick="runDong()">üêª</div>
    <div style="font-size:1rem;font-weight:700;margin-top:6px;">ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</div>
    <div style="font-size:.75rem;color:var(--sub);margin-top:2px;">v2.0 ¬∑ ‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</div>
  </div>
  <div class="settings-card">
    <div class="sc-title">AI</div>
    <div class="si2" onclick="openApiModal()">
      <div class="si2-left"><div class="si2-label">üîë Claude API Key</div><div class="si2-sub">‡πÉ‡∏™‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
  </div>
  <div class="settings-card">
    <div class="sc-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <div class="si2" onclick="exportData()">
      <div class="si2-left"><div class="si2-label">üíæ ‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div><div class="si2-sub">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î JSON backup</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
    <div class="si2" onclick="document.getElementById('restoreInput').click()">
      <div class="si2-left"><div class="si2-label">üì• ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div><div class="si2-sub">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏ü‡∏•‡πå backup</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
    <input type="file" id="restoreInput" style="display:none" accept=".json" onchange="importData(event)">
    <div class="si2" onclick="clearData()">
      <div class="si2-left"><div class="si2-label" style="color:var(--pink);">üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="si2-sub">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-home"     onclick="goPanel('panel-home')">    <span class="ni">üè†</span>‡∏™‡∏£‡∏∏‡∏õ</button>
  <button class="nav-btn"        id="nav-add"      onclick="goPanel('panel-add')">     <span class="ni">‚úèÔ∏è</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="nav-btn"        id="nav-budget"   onclick="goPanel('panel-budget')">  <span class="ni">ü•ß</span>‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö</button>
  <button class="nav-btn"        id="nav-history"  onclick="goPanel('panel-history')"> <span class="ni">üìã</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  <button class="nav-btn"        id="nav-settings" onclick="goPanel('panel-settings')"><span class="ni">‚öôÔ∏è</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
</nav>

<!-- Budget sheet -->
<div class="overlay hidden" id="budgetSheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏´‡∏°‡∏ß‡∏î</div>
    <div style="font-size:.78rem;color:var(--sub);margin-bottom:10px;">‡πÉ‡∏™‡πà 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö</div>
    <input class="sheet-input" type="number" id="sheetInput" placeholder="0" inputmode="decimal">
    <div class="sheet-btns">
      <button class="btn-sheet-cancel" onclick="closeSheet()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-sheet-save" id="btnSheetSave" onclick="saveBudget()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- API Key modal -->
<div class="modal-overlay hidden" id="apiModal">
  <div class="modal-sheet">
    <div class="sheet-handle"></div>
    <h3>üîë Claude API Key</h3>
    <p>‡πÉ‡∏™‡πà Anthropic API Key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°<br>Key ‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>
    <input class="sheet-input" type="password" id="apiKeyInput" placeholder="sk-ant-api03-...">
    <div class="modal-btns2">
      <button class="btn-ms-cancel" onclick="closeApiModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-ms-save"   onclick="saveApiKey()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Running dong -->
<div id="dong-run">üêª</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EXP_CATS = [
  {id:'food',    icon:'üçú', name:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£'},
  {id:'drink',   icon:'üßã', name:'‡∏Å‡∏≤‡πÅ‡∏ü'},
  {id:'deliver', icon:'üõµ', name:'‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ'},
  {id:'travel',  icon:'üöå', name:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'},
  {id:'place',   icon:'üè†', name:'‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å'},
  {id:'shop',    icon:'üõçÔ∏è', name:'‡∏ä‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á'},
  {id:'beauty',  icon:'üíÑ', name:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°'},
  {id:'health',  icon:'üíä', name:'‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'},
  {id:'phone',   icon:'üì±', name:'‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'},
  {id:'net',     icon:'üì∂', name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï'},
  {id:'sub',     icon:'üé¨', name:'Subscription'},
  {id:'other',   icon:'üì¶', name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'},
];
const INC_CATS = [
  {id:'salary',   icon:'üíº', name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'},
  {id:'special',  icon:'‚≠ê', name:'‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'},
  {id:'freelance',icon:'üíª', name:'‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå'},
  {id:'sell',     icon:'üè∑Ô∏è', name:'‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á'},
  {id:'invest',   icon:'üìà', name:'‡∏•‡∏á‡∏ó‡∏∏‡∏ô'},
  {id:'gift',     icon:'üéÅ', name:'‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç'},
  {id:'other_i',  icon:'üí∞', name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'},
];
const INC_COLORS = {
  salary:'#34C759', special:'#00C9A7', freelance:'#007AFF',
  sell:'#FF9500', invest:'#AF52DE', gift:'#FF2D55', other_i:'#8E8E93'
};
const TH_MS = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let entries  = JSON.parse(localStorage.getItem('dong_entries') || '[]');
let budgets  = JSON.parse(localStorage.getItem('dong_budgets') || '{}'); // {catId: amount}
let addType  = 'expense';
let selCatId = 'food';
let sumTab   = 'expense';
let budgetTab= 'expense';
let editCatId= null;
let barTmrs  = [];
let piePeriod= 'month';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init(){
  document.getElementById('filterMonth').value = todayYM();
  renderCatGrid2();
  renderAll();
  renderBudgetList();
  initDong();
  renderPieChart();
  // chatIn Enter key + iPhone scroll fix
  const ci=document.getElementById('chatIn');
  if(ci){
    ci.addEventListener('keydown',e=>{ if(e.key==='Enter') parseChat(); });
    ci.addEventListener('focus',()=>{ setTimeout(()=>ci.scrollIntoView({behavior:'smooth',block:'center'}),300); });
  }
}

function todayStr(){ return new Date().toISOString().slice(0,10); }
function todayYM() { return new Date().toISOString().slice(0,7); }
function fmtDate(d){
  const[y,m,day]=d.split('-');
  return parseInt(day)+' '+TH_MS[parseInt(m)-1]+' '+(parseInt(y)+543);
}
function fmt(n){ return Number(n).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmt0(n){ return Number(n).toLocaleString('th-TH',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const key=id.replace('panel-','');
  const nb=document.getElementById('nav-'+key);
  if(nb) nb.classList.add('active');
  if(id==='panel-history') renderHistory();
  if(id==='panel-budget') renderBudgetList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERIOD (simple: this month) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cyclePeriod(){
  showToast('üêª ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUMMARY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchSumTab(tab){
  sumTab=tab;
  document.getElementById('ieExp').classList.toggle('active',tab==='expense');
  document.getElementById('ieInc').classList.toggle('active',tab==='income');
  document.getElementById('sumCardTitle').className='sum-card-title '+(tab==='expense'?'exp-title':'inc-title');
  document.getElementById('sumCardTitle').textContent=tab==='expense'?'‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢':'‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
  renderCatRows();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ALL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  const ym=todayYM();
  const md=entries.filter(e=>e.date.startsWith(ym));
  const inc=md.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const exp=md.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const bal=inc-exp;

  document.getElementById('ieIncAmt').textContent='‡∏ø'+fmt(inc);
  document.getElementById('ieExpAmt').textContent='‡∏ø'+fmt(exp);
  const el=document.getElementById('balAmount');
  el.textContent=(bal<0?'-':'')+'‡∏ø'+fmt(Math.abs(bal));
  el.className='balance-amount '+(bal<0?'negative':bal>0?'positive':'');

  // period label
  const now=new Date();
  const [y,m]=ym.split('-');
  document.getElementById('periodLabel').textContent=
    '1 '+TH_MS[parseInt(m)-1]+' - '+new Date(now.getFullYear(),now.getMonth()+1,0).getDate()+' '+TH_MS[parseInt(m)-1]+' '+(parseInt(y)+543);

  renderCatRows();
  renderPieChart();
}

let barTmrs2=[];
function renderCatRows(){
  barTmrs2.forEach(clearTimeout); barTmrs2=[];
  const ym=todayYM();
  const md=entries.filter(e=>e.date.startsWith(ym)&&e.type===sumTab);
  const catMap={};
  md.forEach(e=>{ catMap[e.catId]=(catMap[e.catId]||0)+e.amount; });
  const total=Object.values(catMap).reduce((s,v)=>s+v,0);

  const cats=sumTab==='expense'?EXP_CATS:INC_CATS;
  const isExp=sumTab==='expense';

  document.getElementById('catRows').innerHTML=cats.map((c,i)=>{
    const amt=catMap[c.id]||0;
    const bgt=budgets[c.id]||0;
    const amtStr='‡∏ø'+fmt0(amt);
    const bgtStr=bgt>0?'‡∏ø'+fmt0(bgt):'-';
    const pct=bgt>0?Math.min(100,(amt/bgt)*100):(total>0?Math.min(100,(amt/total)*100):0);
    const trackCls=isExp?'exp-track':'inc-track';
    const fillStyle=isExp?'background:var(--pink);':'background:'+(INC_COLORS[c.id]||'var(--teal)')+';';
    return `<div class="cat-row">
      <div class="cat-row-top">
        <span class="cat-row-name">${c.name}</span>
        <span class="cat-row-amt">${amtStr} / ${bgtStr}</span>
      </div>
      <div class="bar-track ${trackCls}">
        <div class="bar-fill" id="cbf_${i}" style="width:0%;${fillStyle}"></div>
      </div>
    </div>`;
  }).join('');

  cats.forEach((_,i)=>{
    const c=cats[i];
    const amt=catMap[c.id]||0;
    const bgt=budgets[c.id]||0;
    const pct=bgt>0?Math.min(100,(amt/bgt)*100):(total>0?Math.min(100,(amt/total)*100):0);
    const t=setTimeout(()=>{ const el=document.getElementById('cbf_'+i); if(el)el.style.width=pct+'%'; },60+i*40);
    barTmrs2.push(t);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setAddType(type){
  addType=type;
  document.getElementById('tabExp').classList.toggle('active',type==='expense');
  document.getElementById('tabInc').classList.toggle('active',type==='income');
  document.getElementById('tabExp').classList.toggle('exp',type==='expense');
  document.getElementById('tabInc').classList.toggle('inc',type==='income');
  document.getElementById('btnAdd').className='btn-add '+(type==='expense'?'exp-btn':'inc-btn');
  selCatId=type==='expense'?'food':'salary';
  renderCatGrid2();
  // update chip colors
  document.querySelectorAll('.q-chip').forEach(c=>{
    c.classList.toggle('inc-chip',type==='income');
  });
}

function renderCatGrid2(){
  const cats=addType==='expense'?EXP_CATS:INC_CATS;
  const selCls=addType==='expense'?'exp-sel':'inc-sel';
  document.getElementById('catGrid2').innerHTML=cats.map(c=>`
    <div class="cat-chip2 ${selCatId===c.id?'sel '+selCls:''}" onclick="selCat2('${c.id}')">
      <div class="cc2-icon">${c.icon}</div>
      <div class="cc2-name">${c.name}</div>
    </div>`).join('');
}

function selCat2(id){ selCatId=id; renderCatGrid2(); }

function setAmt(v){
  document.getElementById('inputAmt').value=v;
  document.querySelectorAll('.q-chip').forEach(c=>c.classList.toggle('sel',c.textContent.replace(',','')==v));
}

function addEntry(){
  const amt=parseFloat(document.getElementById('inputAmt').value);
  if(!amt||amt<=0){ showToast('‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ üêª'); return; }
  const note=document.getElementById('noteField').value.trim();
  const allCats=[...EXP_CATS,...INC_CATS];
  const cat=allCats.find(c=>c.id===selCatId)||allCats[0];
  entries.push({id:Date.now(),type:addType,amount:amt,catId:cat.id,catIcon:cat.icon,catName:cat.name,note:note||cat.name,date:todayStr()});
  save(); renderAll();
  document.getElementById('inputAmt').value='';
  document.getElementById('noteField').value='';
  document.querySelectorAll('.q-chip').forEach(c=>c.classList.remove('sel'));
  showToast(addType==='expense'?`‚ù§Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß`:`üíö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
  goPanel('panel-home');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARSE CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function parseChat(){
  const text=document.getElementById('chatIn').value.trim();
  if(!text){showToast('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ ‚≠ê');return;}
  const amt=parseFloat((text.match(/[\d,]+(\.\d+)?/)||[])[0]?.replace(',',''));
  if(!amt){showToast('ÎèàÎÖ∏Ìä∏ ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚≠ê');return;}
  const t=text.toLowerCase();
  let catId='other',type='expense';
  if(/‡∏ä‡∏≤|‡∏Å‡∏≤‡πÅ‡∏ü|‡∏ä‡∏≤‡∏ô‡∏°|‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å|‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô/.test(t)) catId='drink';
  else if(/‡∏Ç‡πâ‡∏≤‡∏ß|‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏Å‡∏¥‡∏ô|‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß|‡∏ú‡∏±‡∏î|‡∏ï‡πâ‡∏°|‡∏™‡πâ‡∏°‡∏ï‡∏≥/.test(t)) catId='food';
  else if(/grab|‡πÄ‡∏î‡∏•‡∏¥|delivery|‡∏™‡πà‡∏á/.test(t)) catId='deliver';
  else if(/‡∏£‡∏ñ|bts|mrt|taxi|‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà|‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á|‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô/.test(t)) catId='travel';
  else if(/‡∏´‡πâ‡∏≠‡∏á|‡∏ö‡πâ‡∏≤‡∏ô|‡πÄ‡∏ä‡πà‡∏≤|‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å/.test(t)) catId='place';
  else if(/‡∏ä‡πâ‡∏≠‡∏õ|‡∏ã‡∏∑‡πâ‡∏≠|‡∏ï‡∏•‡∏≤‡∏î|‡∏ä‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á/.test(t)) catId='shop';
  else if(/‡∏Ñ‡∏£‡∏µ‡∏°|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á|‡∏ú‡∏°|‡∏™‡∏õ‡∏≤|‡∏ó‡∏≥‡∏ú‡∏°/.test(t)) catId='beauty';
  else if(/‡∏´‡∏°‡∏≠|‡∏¢‡∏≤|‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•|‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å/.test(t)) catId='health';
  else if(/‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå|‡πÇ‡∏ó‡∏£|‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£/.test(t)) catId='phone';
  else if(/‡πÄ‡∏ô‡πá‡∏ï|internet|wifi/.test(t)) catId='net';
  else if(/netflix|spotify|sub|‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£/.test(t)) catId='sub';
  else if(/‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô|salary/.test(t)){catId='salary';type='income';}
  else if(/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå|freelance/.test(t)){catId='freelance';type='income';}
  else if(/‡∏Ç‡∏≤‡∏¢/.test(t)){catId='sell';type='income';}
  else if(/‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô|‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ|‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©/.test(t)){catId='special';type='income';}

  const allCats=[...EXP_CATS,...INC_CATS];
  const cat=allCats.find(c=>c.id===catId)||allCats[0];
  entries.push({id:Date.now(),type,amount:amt,catId:cat.id,catIcon:cat.icon,catName:cat.name,note:text,date:todayStr()});
  save(); renderAll();
  const ci=document.getElementById('chatIn');
  ci.value='';
  ci.blur();
  setTimeout(()=>window.scrollTo({top:0,behavior:'smooth'}),100);
  showToast(`${cat.icon} "${cat.name}" ‡∏ø${fmt0(amt)} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchBudgetTab(tab){
  budgetTab=tab;
  document.getElementById('bttExp').classList.toggle('active',tab==='expense');
  document.getElementById('bttInc').classList.toggle('active',tab==='income');
  document.getElementById('bttExp').classList.toggle('exp',tab==='expense');
  document.getElementById('bttInc').classList.toggle('inc',tab==='income');
  renderBudgetList();
}

function renderBudgetList(){
  const cats=budgetTab==='expense'?EXP_CATS:INC_CATS;
  document.getElementById('budgetList').innerHTML=cats.map(c=>{
    const b=budgets[c.id];
    const bStr=b>0?'‡∏ø'+fmt0(b):'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö';
    return `<div class="budget-item" onclick="openSheet('${c.id}','${c.name}')">
      <span class="bi-name">${c.name}</span>
      <div class="bi-right">
        <span class="bi-budget">‡∏á‡∏ö ${bStr}</span>
        <span class="bi-arrow">‚Ä∫</span>
      </div>
    </div>`;
  }).join('');
}

function openSheet(catId,catName){
  editCatId=catId;
  document.getElementById('sheetTitle').textContent='‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö "'+catName+'"';
  document.getElementById('sheetInput').value=budgets[catId]>0?budgets[catId]:'';
  document.getElementById('btnSheetSave').className='btn-sheet-save '+(budgetTab==='income'?'inc-save':'');
  document.getElementById('budgetSheet').classList.remove('hidden');
}
function closeSheet(){ document.getElementById('budgetSheet').classList.add('hidden'); }
function saveBudget(){
  const v=parseFloat(document.getElementById('sheetInput').value)||0;
  if(v>0) budgets[editCatId]=v;
  else delete budgets[editCatId];
  localStorage.setItem('dong_budgets',JSON.stringify(budgets));
  closeSheet(); renderBudgetList(); renderCatRows();
  showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory(){
  const ym=document.getElementById('filterMonth').value;
  const ft=document.getElementById('filterType').value;
  let data=entries.filter(e=>e.date.startsWith(ym));
  if(ft!=='all') data=data.filter(e=>e.type===ft);
  data.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const c=document.getElementById('txList2');
  if(!data.length){c.innerHTML=`<div class="empty2">üêª<br><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏ô‡∏∞</div>`;return;}
  c.innerHTML=data.map(e=>`
    <div class="tx2 ${e.type}">
      <div class="tx2-icon">${e.catIcon||'üí∞'}</div>
      <div class="tx2-info">
        <div class="tx2-desc">${esc(e.note)}</div>
        <div class="tx2-meta">${e.catName} ¬∑ ${fmtDate(e.date)}</div>
      </div>
      <div class="tx2-amt">${e.type==='income'?'+':'-'}‡∏ø${fmt0(e.amount)}</div>
      <button class="tx2-del" onclick="delEntry(${e.id})">üóëÔ∏è</button>
    </div>`).join('');
}

function delEntry(id){
  entries=entries.filter(e=>e.id!==id);
  save(); renderAll(); renderHistory();
  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openApiModal(){
  document.getElementById('apiKeyInput').value=localStorage.getItem('dong_api_key')||'';
  document.getElementById('apiModal').classList.remove('hidden');
}
function closeApiModal(){ document.getElementById('apiModal').classList.add('hidden'); }
function saveApiKey(){
  localStorage.setItem('dong_api_key',document.getElementById('apiKeyInput').value.trim());
  closeApiModal(); showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å API Key ‡πÅ‡∏•‡πâ‡∏ß');
}
function exportData(){
  const b=new Blob([JSON.stringify({entries,budgets})],{type:'application/json'});
  const a=document.createElement('a');a.href=URL.createObjectURL(b);a.download='dongdong_backup.json';a.click();
}
function importData(ev){
  const r=new FileReader();
  r.onload=e=>{try{const d=JSON.parse(e.target.result);entries=d.entries||[];budgets=d.budgets||{};save();renderAll();showToast('‚úÖ ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡πâ‡∏ß');}catch{showToast('‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');}};
  r.readAsText(ev.target.files[0]);
}
function clearData(){
  if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏°?'))return;
  entries=[];budgets={};save();renderAll();showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PIE CHART ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPiePeriod(p){
  piePeriod=p;
  document.getElementById('pieTabDay').classList.toggle('active',p==='day');
  document.getElementById('pieTabMonth').classList.toggle('active',p==='month');
  renderPieChart();
}

function renderPieChart(){
  const filter=piePeriod==='day'?todayStr():todayYM();
  const data=entries.filter(e=>e.date.startsWith(filter));
  const inc=data.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const exp=data.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const total=inc+exp;

  const canvas=document.getElementById('pieChart');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const cx=canvas.width/2, cy=canvas.height/2;
  const r=Math.min(cx,cy)-8;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(total===0){
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='#E5E5EA';ctx.fill();
    ctx.beginPath();ctx.arc(cx,cy,r*0.55,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    ctx.fillStyle='#8E8E93';ctx.font='bold 12px -apple-system';
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',cx,cy);
  } else {
    const expAngle=(exp/total)*Math.PI*2;
    const incAngle=(inc/total)*Math.PI*2;
    const start=-Math.PI/2;
    // Expense slice
    if(exp>0){
      ctx.beginPath();ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+expAngle);
      ctx.closePath();ctx.fillStyle='#FF4785';ctx.fill();
    }
    // Income slice
    if(inc>0){
      ctx.beginPath();ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start+expAngle,start+expAngle+incAngle);
      ctx.closePath();ctx.fillStyle='#00C9A7';ctx.fill();
    }
    // Donut hole
    ctx.beginPath();ctx.arc(cx,cy,r*0.56,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    // Center label
    ctx.fillStyle='#1C1C1E';ctx.font='bold 13px -apple-system';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('‡∏ø'+fmt0(total),cx,cy);
  }

  // Legend
  document.getElementById('pieLegend').innerHTML=`
    <div class="pie-legend-item">
      <div class="pie-dot" style="background:#FF4785;"></div>
      <span>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏ø${fmt0(exp)}</span>
    </div>
    <div class="pie-legend-item">
      <div class="pie-dot" style="background:#00C9A7;"></div>
      <span>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏ø${fmt0(inc)}</span>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DONG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initDong(){
  const h=new Date().getHours();
  const emoji=h<6?'üêª‚Äç‚ùÑÔ∏è':h<12?'üêª‚Äç‚ùÑÔ∏è':h<18?'üêª':h<22?'üêª':'üêª';
  document.getElementById('dong-run').textContent=emoji;
  document.getElementById('headerBear').textContent=emoji;
  document.getElementById('settingsBear').textContent=emoji;
  document.getElementById('homeBear').textContent=emoji;
  document.getElementById('dong-run').onclick=()=>{
    const msgs=['ÎèàÎÖ∏Ìä∏: ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞! ‚≠ê','ÎèàÎÖ∏Ìä∏: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å üí∞','ÎèàÎÖ∏Ìä∏: ‡∏£‡∏±‡∏Å‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢ ‚≠êüíï'];
    showToast(msgs[Math.floor(Math.random()*msgs.length)]);
  };
}
function runDong(){
  document.getElementById('dong-run').style.animation='none';
  setTimeout(()=>{ document.getElementById('dong-run').style.animation='dong-run 6s linear'; },10);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save(){ localStorage.setItem('dong_entries',JSON.stringify(entries)); }
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

init();
</script>
</body>
</html>
