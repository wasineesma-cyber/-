<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Don Note">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FF4785">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<title>ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</title>
<style>
:root {
  --pink:       #FF4785;
  --pink-light: #FFF0F5;
  --pink-border:#FFADD2;
  --pink-track: #FFD6E7;
  --teal:       #00C9A7;
  --teal-light: #E8FAF7;
  --teal-border:#80E5D8;
  --teal-track: #B2F0E8;
  --bg:         #F5F5F5;
  --white:      #FFFFFF;
  --text:       #1C1C1E;
  --sub:        #8E8E93;
  --border:     #E5E5EA;
  --nav-h:      60px;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Text','Segoe UI',sans-serif;}
body{padding-bottom:var(--nav-h);}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{
  background:var(--white);
  padding:12px 18px;
  padding-top:calc(12px + env(safe-area-inset-top));
  display:flex;align-items:center;justify-content:center;
  position:relative;
}
.header-title{font-size:1rem;font-weight:700;color:var(--text);}
.header-bear{
  position:absolute;left:16px;
  font-size:1.3rem;cursor:pointer;
}
.header-right{position:absolute;right:16px;font-size:.8rem;color:var(--sub);}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  height:var(--nav-h);
  background:var(--white);
  border-top:1px solid var(--border);
  display:grid;grid-template-columns:repeat(5,1fr);
  padding-bottom:env(safe-area-inset-bottom);
  z-index:100;
}
.nav-btn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;background:none;border:none;cursor:pointer;
  color:var(--sub);font-size:.58rem;font-weight:600;letter-spacing:.02em;
  transition:color .2s;
}
.nav-btn .ni{font-size:1.3rem;}
.nav-btn.active{color:var(--pink);}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{display:none;max-width:480px;margin:0 auto;padding:14px 14px;}
.panel.active{display:block;}

/* ‚îÄ‚îÄ ‡∏™‡∏£‡∏∏‡∏õ PANEL ‚îÄ‚îÄ */

/* Period pill */
.period-pill{
  display:flex;align-items:center;justify-content:center;
  gap:6px;margin:0 auto 14px;
  background:var(--white);border:1px solid var(--border);
  border-radius:20px;padding:8px 18px;
  font-size:.85rem;font-weight:600;color:var(--text);
  width:fit-content;cursor:pointer;
}

/* Balance */
.balance-wrap{text-align:center;margin-bottom:14px;}
.balance-label{font-size:.72rem;color:var(--sub);font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
.balance-amount{font-size:2.6rem;font-weight:900;margin:4px 0 8px;color:#1C1C1E;}
.balance-amount.positive{color:#34C759;}
.balance-amount.negative{color:var(--pink);}
.period-btn{
  display:inline-flex;align-items:center;gap:5px;
  border:1px solid var(--border);border-radius:20px;
  padding:6px 14px;font-size:.78rem;font-weight:600;color:var(--text);
  background:var(--white);cursor:pointer;
}

/* Inc/Exp cards */
.ie-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.ie-card{
  padding:14px 14px;border-radius:16px;border:2px solid var(--border);
  background:var(--white);cursor:pointer;transition:border-color .2s;
}
.ie-card.exp-card{background:var(--pink-light);}
.ie-card.inc-card{background:var(--teal-light);}
.ie-card.active.exp-card{border-color:var(--pink);}
.ie-card.active.inc-card{border-color:var(--teal);}
.ie-card .iec-label{font-size:.72rem;font-weight:700;margin-bottom:5px;}
.ie-card.exp-card .iec-label{color:var(--pink);}
.ie-card.inc-card .iec-label{color:var(--teal);}
.ie-card .iec-amount{font-size:1.25rem;font-weight:900;}
.ie-card.exp-card .iec-amount{color:var(--pink);}
.ie-card.inc-card .iec-amount{color:var(--teal);}

/* Summary card */
.sum-card{
  background:var(--white);border-radius:20px;
  padding:18px 16px;
  box-shadow:0 1px 6px rgba(0,0,0,.07);
}
.sum-card-header{
  display:flex;align-items:center;gap:10px;
  margin-bottom:18px;
}
.dong-badge{
  width:44px;height:44px;flex-shrink:0;
  background:radial-gradient(circle,#fff8e7,#fff0d0);
  border:2px solid #F0C040;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.55rem;font-weight:800;color:#C07800;text-align:center;
  line-height:1.2;letter-spacing:.01em;
  box-shadow:0 2px 6px rgba(192,120,0,.2);
}
.sum-card-title{
  flex:1;text-align:center;
  font-size:1.05rem;font-weight:800;
}
.sum-card-title.exp-title{color:var(--pink);}
.sum-card-title.inc-title{color:var(--teal);}

/* Category rows */
.cat-row{margin-bottom:14px;}
.cat-row-top{
  display:flex;justify-content:space-between;align-items:baseline;
  margin-bottom:5px;
}
.cat-row-name{font-size:.92rem;font-weight:600;color:var(--text);}
.cat-row-amt{font-size:.82rem;color:var(--sub);}
.bar-track{height:5px;border-radius:4px;overflow:hidden;}
.bar-track.exp-track{background:var(--pink-track);}
.bar-track.inc-track{background:var(--teal-track);}
.bar-fill{height:100%;border-radius:4px;transition:width .9s ease;}
.bar-fill.exp-fill{background:var(--pink);}

/* Manage budget btn */
.btn-manage{
  width:100%;padding:13px;margin-top:10px;
  background:var(--white);border:1px solid var(--border);
  border-radius:12px;font-size:.88rem;font-weight:600;
  color:var(--text);cursor:pointer;transition:background .2s;
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.btn-manage:hover{background:var(--bg);}

/* ‚îÄ‚îÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PANEL ‚îÄ‚îÄ */
.add-header{text-align:center;font-size:1rem;font-weight:700;padding:4px 0 14px;}

.type-tabs{
  display:grid;grid-template-columns:1fr 1fr;gap:0;
  background:var(--bg);border-radius:12px;padding:3px;
  margin-bottom:16px;
}
.type-tab{
  padding:10px;border:none;border-radius:10px;
  font-size:.88rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.type-tab.active.exp{background:var(--white);color:var(--pink);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.type-tab.active.inc{background:var(--white);color:var(--teal);box-shadow:0 1px 4px rgba(0,0,0,.1);}

.amount-box{
  background:var(--bg);border-radius:16px;padding:16px 18px;
  margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.amount-box .curr{font-size:1.4rem;font-weight:800;color:var(--sub);}
.amount-box input{
  flex:1;border:none;background:transparent;outline:none;
  font-size:2rem;font-weight:900;color:var(--text);font-family:inherit;
}

.quick-row{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
.q-chip{
  padding:7px 16px;border-radius:20px;
  border:1px solid var(--border);background:var(--white);
  font-size:.82rem;font-weight:600;color:var(--text);cursor:pointer;
  transition:all .2s;
}
.q-chip:hover,.q-chip.sel{background:var(--pink);border-color:var(--pink);color:#fff;}
.q-chip.sel.inc-chip{background:var(--teal);border-color:var(--teal);}

.form-label{font-size:.7rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.cat-grid2{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
.cat-chip2{
  padding:10px 4px;border-radius:14px;border:2px solid var(--border);
  background:var(--white);cursor:pointer;text-align:center;
  transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px;
}
.cat-chip2 .cc2-icon{font-size:1.25rem;}
.cat-chip2 .cc2-name{font-size:.6rem;font-weight:600;color:var(--sub);}
.cat-chip2.sel.exp-sel{border-color:var(--pink);background:var(--pink-light);}
.cat-chip2.sel.inc-sel{border-color:var(--teal);background:var(--teal-light);}

.note-field{
  width:100%;padding:12px 14px;
  border:1px solid var(--border);border-radius:12px;
  font-size:.9rem;font-family:inherit;outline:none;
  background:var(--white);color:var(--text);margin-bottom:14px;
}

.btn-add{
  width:100%;padding:14px;border:none;border-radius:14px;
  font-size:1rem;font-weight:800;color:#fff;cursor:pointer;
}
.btn-add.exp-btn{background:var(--pink);box-shadow:0 4px 14px rgba(255,71,133,.3);}
.btn-add.inc-btn{background:var(--teal);box-shadow:0 4px 14px rgba(0,201,167,.3);}

/* ‚îÄ‚îÄ ‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö PANEL ‚îÄ‚îÄ */
.budget-header{font-size:1.1rem;font-weight:800;text-align:center;margin-bottom:14px;}
.period-setting-card{
  background:var(--white);border-radius:16px;padding:14px 16px;
  margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.05);
}
.psc-left .psc-title{font-size:.8rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.05em;}
.psc-left .psc-val{font-size:.9rem;font-weight:600;margin-top:3px;}

.budget-type-tabs{
  display:grid;grid-template-columns:1fr 1fr;gap:0;
  background:var(--bg);border-radius:12px;padding:3px;
  margin-bottom:12px;
}
.btt{
  padding:10px;border:none;border-radius:10px;
  font-size:.88rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.btt.active.exp{background:var(--white);color:var(--pink);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.btt.active.inc{background:var(--white);color:var(--teal);box-shadow:0 1px 4px rgba(0,0,0,.1);}

.budget-list{display:flex;flex-direction:column;gap:8px;}
.budget-item{
  background:var(--white);border-radius:14px;padding:14px 16px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.05);cursor:pointer;
}
.bi-name{font-size:.92rem;font-weight:600;}
.bi-right{display:flex;align-items:center;gap:8px;}
.bi-budget{font-size:.8rem;color:var(--sub);}

/* ‚îÄ‚îÄ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PANEL ‚îÄ‚îÄ */
.tx-list2{display:flex;flex-direction:column;gap:8px;}
.tx2{
  background:var(--white);border-radius:14px;padding:13px 14px;
  display:flex;align-items:center;gap:11px;
}
.tx2-icon{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;}
.tx2.expense .tx2-icon{background:var(--pink-light);}
.tx2.income  .tx2-icon{background:var(--teal-light);}
.tx2-info{flex:1;min-width:0;}
.tx2-desc{font-size:.88rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx2-amt{font-size:.92rem;font-weight:800;}
.tx2.expense .tx2-amt{color:var(--pink);}
.tx2.income  .tx2-amt{color:var(--teal);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:80px;left:50%;
  transform:translateX(-50%);
  background:#1C1C1E;color:#fff;
  padding:10px 20px;border-radius:20px;
  font-size:.85rem;opacity:0;transition:all .3s;z-index:999;
}
.toast.show{opacity:1;}

/* ‚îÄ‚îÄ CHAT BOX ‚îÄ‚îÄ */
.chat-box{
  background:var(--white);border-radius:16px;padding:14px;
  box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:14px;
}

/* ‚îÄ‚îÄ MODALS ‚îÄ‚îÄ */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:500;
}
.overlay.hidden{display:none;}
.sheet{
  background:var(--white);border-radius:24px 24px 0 0;
  width:100%;max-width:480px;padding:20px;
}
.sheet-input{
  width:100%;padding:12px;border:1px solid var(--border);
  border-radius:12px;margin-bottom:12px;background:var(--bg);
}

/* ‚îÄ‚îÄ SPLASH ‚îÄ‚îÄ */
#splash{
  position:fixed;inset:0;z-index:9999;
  background:#FF4785;display:flex;flex-direction:column;align-items:center;justify-content:center;
  transition:opacity .5s;
}
#splash.hide{opacity:0;pointer-events:none;}
</style>
</head>
<body>

<div id="splash">
  <div style="font-size:72px;">üêº</div>
  <div style="color:#fff;font-size:1.5rem;font-weight:800;">Don Note</div>
</div>

<div class="header">
  <div class="header-bear" id="headerBear">üêº</div>
  <div class="header-title">Îèà‡πÇ‡∏ô‡πâ‡∏ï Don Note ‚≠ê</div>
</div>

<div class="panel active" id="panel-home">
  <div class="balance-wrap">
    <div class="balance-label">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö</div>
    <div class="balance-amount" id="balAmount">‡∏ø0</div>
    <div id="periodLabel" style="font-size:.8rem;color:var(--sub);"></div>
  </div>

  <div class="chat-box">
    <div class="form-label">‚ö° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏Å‡∏≤‡πÅ‡∏ü 60"</div>
    <div style="display:flex;gap:8px;">
      <input class="note-field" id="chatIn" placeholder="‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß 80" style="margin:0;flex:1;">
      <button onclick="parseChat()" style="padding:0 18px;border:none;border-radius:12px;background:var(--pink);color:#fff;font-weight:700;">‚û§</button>
    </div>
  </div>

  <div class="ie-grid">
    <div class="ie-card exp-card active" id="ieExp" onclick="switchSumTab('expense')">
      <div class="iec-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div class="iec-amount" id="ieExpAmt">‡∏ø0.00</div>
    </div>
    <div class="ie-card inc-card" id="ieInc" onclick="switchSumTab('income')">
      <div class="iec-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
      <div class="iec-amount" id="ieIncAmt">‡∏ø0.00</div>
    </div>
  </div>

  <div class="sum-card">
    <div id="catRows"></div>
    <button class="btn-manage" onclick="goPanel('panel-budget')">‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö</button>
  </div>
</div>

<div class="panel" id="panel-add">
  <div class="add-header">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
  <div class="type-tabs">
    <button class="type-tab exp active" id="tabExp" onclick="setAddType('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="type-tab inc"        id="tabInc" onclick="setAddType('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
  </div>
  <div class="amount-box">
    <span class="curr">‡∏ø</span>
    <input type="number" id="inputAmt" placeholder="0">
  </div>
  <div class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
  <div class="cat-grid2" id="catGrid2"></div>
  <input class="note-field" id="noteField" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
  <button class="btn-add exp-btn" id="btnAdd" onclick="addEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úì</button>
</div>

<div class="panel" id="panel-budget">
  <div class="budget-header">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏á‡∏ö</div>
  <div class="period-setting-card">
    <div class="psc-left">
      <div class="psc-title">‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏î‡∏á‡∏ö</div>
      <div class="psc-val">
        üìÖ 
        <select id="cycleType" onchange="saveCycleSettings()" style="border:none;background:transparent;font-weight:600;outline:none;">
          <option value="monthly">‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</option>
          <option value="weekly">‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (‡∏ß‡∏±‡∏ô‡∏à‡∏±‡∏ô‡∏ó‡∏£‡πå)</option>
        </select>
      </div>
    </div>
  </div>
  <div class="budget-type-tabs">
    <button class="btt exp active" id="bttExp" onclick="switchBudgetTab('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="btt inc"        id="bttInc" onclick="switchBudgetTab('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
  </div>
  <div class="budget-list" id="budgetList"></div>
</div>

<div class="panel" id="panel-history">
  <div class="tx-list2" id="txList2"></div>
</div>

<nav class="bottom-nav">
  <button class="nav-btn active" onclick="goPanel('panel-home')">üè†‡∏™‡∏£‡∏∏‡∏õ</button>
  <button class="nav-btn" onclick="goPanel('panel-add')">‚úèÔ∏è‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="nav-btn" onclick="goPanel('panel-budget')">ü•ß‡∏á‡∏ö</button>
  <button class="nav-btn" onclick="goPanel('panel-history')">üìã‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
</nav>

<div class="toast" id="toast"></div>

<script>
// --- CONFIG ---
const firebaseConfig = {
  apiKey: "AIzaSyAOAr6OsQpf_e-xv8qfLyIUu6Dant1MkS4",
  authDomain: "don-note.firebaseapp.com",
  projectId: "don-note",
  storageBucket: "don-note.firebasestorage.app",
  messagingSenderId: "661381674055",
  appId: "1:661381674055:web:0427dc17348fb11b56ed62"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const LIFF_ID = '2009230946-hp9vcPh3';

// --- STATE ---
let userId = "guest";
let entries = [];
let budgets = {};
let cycle = "monthly";
let addType = "expense";
let selCatId = "food";
let sumTab = "expense";

const EXP_CATS = [
  {id:'food', icon:'üçú', name:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£'},
  {id:'drink', icon:'üßã', name:'‡∏ô‡πâ‡∏≥/‡∏Å‡∏≤‡πÅ‡∏ü'},
  {id:'travel', icon:'üöå', name:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'},
  {id:'shop', icon:'üõçÔ∏è', name:'‡∏ä‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á'},
  {id:'other', icon:'üì¶', name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}
];
const INC_CATS = [
  {id:'salary', icon:'üíº', name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'},
  {id:'gift', icon:'üéÅ', name:'‡πÉ‡∏´‡πâ‡∏°‡∏≤'},
  {id:'other_i', icon:'üí∞', name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'}
];

// --- INIT ---
async function init() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      const profile = await liff.getProfile();
      userId = profile.userId;
    }
    await loadData();
    renderAll();
    renderCatGrid2();
  } catch (e) { console.error(e); }
  
  document.getElementById('splash').classList.add('hide');
}

async function loadData() {
  const doc = await db.collection('dongNote').doc(userId).get();
  if (doc.exists) {
    const data = doc.data();
    entries = data.entries || [];
    budgets = data.budgets || {};
    cycle = data.settings?.cycle || "monthly";
    document.getElementById('cycleType').value = cycle;
  }
}

async function saveData() {
  await db.collection('dongNote').doc(userId).set({
    entries, budgets, settings: { cycle }
  }, { merge: true });
}

// --- NAV ---
function goPanel(id) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  if(id === 'panel-history') renderHistory();
}

// --- LOGIC ---
function renderAll() {
  const now = new Date();
  let filtered = entries;
  
  // ‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ
  if (cycle === "monthly") {
    const ym = now.toISOString().slice(0, 7);
    filtered = entries.filter(e => e.date.startsWith(ym));
  } else {
    // ‡∏£‡∏≤‡∏¢‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå (7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
    const weekAgo = new Date();
    weekAgo.setDate(now.getDate() - 7);
    filtered = entries.filter(e => new Date(e.date) >= weekAgo);
  }

  const inc = filtered.filter(e => e.type === 'income').reduce((s, e) => s + e.amount, 0);
  const exp = filtered.filter(e => e.type === 'expense').reduce((s, e) => s + e.amount, 0);
  
  document.getElementById('ieIncAmt').textContent = '‡∏ø' + inc.toLocaleString();
  document.getElementById('ieExpAmt').textContent = '‡∏ø' + exp.toLocaleString();
  document.getElementById('balAmount').textContent = '‡∏ø' + (inc - exp).toLocaleString();
  
  renderCatRows(filtered);
}

function renderCatRows(data) {
  const target = data.filter(e => e.type === sumTab);
  const cats = sumTab === 'expense' ? EXP_CATS : INC_CATS;
  
  let html = '';
  cats.forEach(c => {
    const amt = target.filter(e => e.catId === c.id).reduce((s, e) => s + e.amount, 0);
    html += `
      <div class="cat-row">
        <div class="cat-row-top"><span>${c.icon} ${c.name}</span><span>‡∏ø${amt}</span></div>
        <div class="bar-track ${sumTab==='expense'?'exp-track':'inc-track'}">
          <div class="bar-fill" style="width:${amt > 0 ? '50%' : '0%'}; background:${sumTab==='expense'?'var(--pink)':'var(--teal)'}"></div>
        </div>
      </div>`;
  });
  document.getElementById('catRows').innerHTML = html;
}

function setAddType(t) {
  addType = t;
  document.getElementById('tabExp').classList.toggle('active', t==='expense');
  document.getElementById('tabInc').classList.toggle('active', t==='income');
  renderCatGrid2();
}

function renderCatGrid2() {
  const cats = addType === 'expense' ? EXP_CATS : INC_CATS;
  document.getElementById('catGrid2').innerHTML = cats.map(c => `
    <div class="cat-chip2 ${selCatId===c.id?'sel':''}" onclick="selCatId='${c.id}';renderCatGrid2()">
      <div class="cc2-icon">${c.icon}</div>
      <div class="cc2-name">${c.name}</div>
    </div>`).join('');
}

async function addEntry() {
  const amt = parseFloat(document.getElementById('inputAmt').value);
  if (!amt) return showToast("‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞");
  
  entries.push({
    id: Date.now(),
    type: addType,
    amount: amt,
    catId: selCatId,
    date: new Date().toISOString().slice(0, 10),
    note: document.getElementById('noteField').value || "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏´‡∏°‡πà"
  });
  
  await saveData();
  showToast("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚≠ê");
  document.getElementById('inputAmt').value = '';
  goPanel('panel-home');
  renderAll();
}

async function saveCycleSettings() {
  cycle = document.getElementById('cycleType').value;
  await saveData();
  showToast("‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‚ú®");
  renderAll();
}

function parseChat() {
  const val = document.getElementById('chatIn').value;
  const amt = parseFloat(val.match(/\d+/));
  if (amt) {
    document.getElementById('inputAmt').value = amt;
    document.getElementById('noteField').value = val.replace(/\d+/, '').trim();
    addEntry();
    document.getElementById('chatIn').value = '';
  }
}

function renderHistory() {
  const html = entries.slice().reverse().map(e => `
    <div class="tx2 ${e.type}">
      <div class="tx2-icon">üí∞</div>
      <div class="tx2-info">
        <div class="tx2-desc">${e.note}</div>
        <div class="tx2-meta">${e.date}</div>
      </div>
      <div class="tx2-amt">‡∏ø${e.amount}</div>
    </div>`).join('');
  document.getElementById('txList2').innerHTML = html || "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£";
}

function showToast(m) {
  const t = document.getElementById('toast');
  t.textContent = m; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2000);
}

function switchSumTab(t) {
  sumTab = t;
  document.getElementById('ieExp').classList.toggle('active', t==='expense');
  document.getElementById('ieInc').classList.toggle('active', t==='income');
  renderAll();
}

init();
</script>
</body>
</html>
