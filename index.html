<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Don Note">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#FF4785">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<title>ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</title>
<style>
:root {
  --pink:       #FF4785;
  --pink-light: #FFF0F5;
  --pink-border:#FFADD2;
  --pink-track: #FFD6E7;
  --teal:       #00C9A7;
  --teal-light: #E8FAF7;
  --teal-border:#80E5D8;
  --teal-track: #B2F0E8;
  --bg:         #F5F5F5;
  --white:      #FFFFFF;
  --text:       #1C1C1E;
  --sub:        #8E8E93;
  --border:     #E5E5EA;
  --nav-h:      60px;
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:-apple-system,'SF Pro Text','Segoe UI',sans-serif;}
body{padding-bottom:var(--nav-h);}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
.header{
  background:var(--white);
  padding:12px 18px;
  padding-top:calc(12px + env(safe-area-inset-top));
  display:flex;align-items:center;justify-content:center;
  position:relative;
}
.header-title{font-size:1rem;font-weight:700;color:var(--text);}
.header-bear{
  position:absolute;left:16px;
  font-size:1.3rem;cursor:pointer;
}
.header-right{position:absolute;right:16px;font-size:.8rem;color:var(--sub);}

/* ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;
  height:var(--nav-h);
  background:var(--white);
  border-top:1px solid var(--border);
  display:grid;grid-template-columns:repeat(5,1fr);
  padding-bottom:env(safe-area-inset-bottom);
  z-index:100;
}
.nav-btn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;background:none;border:none;cursor:pointer;
  color:var(--sub);font-size:.58rem;font-weight:600;letter-spacing:.02em;
  transition:color .2s;
}
.nav-btn .ni{font-size:1.3rem;}
.nav-btn.active{color:var(--pink);}

/* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
.panel{display:none;max-width:480px;margin:0 auto;padding:14px 14px;}
.panel.active{display:block;}

/* ‚îÄ‚îÄ ‡∏™‡∏£‡∏∏‡∏õ PANEL ‚îÄ‚îÄ */

/* Period pill */
.period-pill{
  display:flex;align-items:center;justify-content:center;
  gap:6px;margin:0 auto 14px;
  background:var(--white);border:1px solid var(--border);
  border-radius:20px;padding:8px 18px;
  font-size:.85rem;font-weight:600;color:var(--text);
  width:fit-content;cursor:pointer;
}
.period-pill .pi-arrow{color:var(--sub);font-size:.7rem;}

/* Balance */
.balance-wrap{text-align:center;margin-bottom:14px;}
.balance-label{font-size:.72rem;color:var(--sub);font-weight:600;text-transform:uppercase;letter-spacing:.06em;}
.balance-amount{font-size:2.6rem;font-weight:900;margin:4px 0 8px;color:#1C1C1E;}
.balance-amount.positive{color:#34C759;}
.balance-amount.negative{color:var(--pink);}
.period-btn{
  display:inline-flex;align-items:center;gap:5px;
  border:1px solid var(--border);border-radius:20px;
  padding:6px 14px;font-size:.78rem;font-weight:600;color:var(--text);
  background:var(--white);cursor:pointer;
}

/* Inc/Exp cards */
.ie-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;}
.ie-card{
  padding:14px 14px;border-radius:16px;border:2px solid var(--border);
  background:var(--white);cursor:pointer;transition:border-color .2s;
}
.ie-card.exp-card{background:var(--pink-light);}
.ie-card.inc-card{background:var(--teal-light);}
.ie-card.active.exp-card{border-color:var(--pink);}
.ie-card.active.inc-card{border-color:var(--teal);}
.ie-card .iec-label{font-size:.72rem;font-weight:700;margin-bottom:5px;}
.ie-card.exp-card .iec-label{color:var(--pink);}
.ie-card.inc-card .iec-label{color:var(--teal);}
.ie-card .iec-amount{font-size:1.25rem;font-weight:900;}
.ie-card.exp-card .iec-amount{color:var(--pink);}
.ie-card.inc-card .iec-amount{color:var(--teal);}

/* Summary card */
.sum-card{
  background:var(--white);border-radius:20px;
  padding:18px 16px;
  box-shadow:0 1px 6px rgba(0,0,0,.07);
}
.sum-card-header{
  display:flex;align-items:center;gap:10px;
  margin-bottom:18px;
}
.dong-badge{
  width:44px;height:44px;flex-shrink:0;
  background:radial-gradient(circle,#fff8e7,#fff0d0);
  border:2px solid #F0C040;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:.55rem;font-weight:800;color:#C07800;text-align:center;
  line-height:1.2;letter-spacing:.01em;
  box-shadow:0 2px 6px rgba(192,120,0,.2);
}
.sum-card-title{
  flex:1;text-align:center;
  font-size:1.05rem;font-weight:800;
}
.sum-card-title.exp-title{color:var(--pink);}
.sum-card-title.inc-title{color:var(--teal);}

/* Category rows */
.cat-row{margin-bottom:14px;}
.cat-row-top{
  display:flex;justify-content:space-between;align-items:baseline;
  margin-bottom:5px;
}
.cat-row-name{font-size:.92rem;font-weight:600;color:var(--text);}
.cat-row-amt{font-size:.82rem;color:var(--sub);}
.bar-track{height:5px;border-radius:4px;overflow:hidden;}
.bar-track.exp-track{background:var(--pink-track);}
.bar-track.inc-track{background:var(--teal-track);}
.bar-fill{height:100%;border-radius:4px;transition:width .9s ease;}
.bar-fill.exp-fill{background:var(--pink);}

/* Manage budget btn */
.btn-manage{
  width:100%;padding:13px;margin-top:10px;
  background:var(--white);border:1px solid var(--border);
  border-radius:12px;font-size:.88rem;font-weight:600;
  color:var(--text);cursor:pointer;transition:background .2s;
  display:flex;align-items:center;justify-content:center;gap:6px;
}
.btn-manage:hover{background:var(--bg);}

/* Invite banner */
.invite-banner{
  width:100%;padding:14px;margin-top:10px;
  background:linear-gradient(135deg,var(--pink),#FF7BB5);
  border:none;border-radius:14px;font-size:.88rem;font-weight:800;
  color:#fff;cursor:pointer;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.invite-badge{
  background:#FFD700;color:#8B6914;font-size:.62rem;font-weight:900;
  padding:3px 8px;border-radius:12px;white-space:nowrap;
}

/* ‚îÄ‚îÄ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å PANEL ‚îÄ‚îÄ */
.add-header{text-align:center;font-size:1rem;font-weight:700;padding:4px 0 14px;}

.type-tabs{
  display:grid;grid-template-columns:1fr 1fr;gap:0;
  background:var(--bg);border-radius:12px;padding:3px;
  margin-bottom:16px;
}
.type-tab{
  padding:10px;border:none;border-radius:10px;
  font-size:.88rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.type-tab.active.exp{background:var(--white);color:var(--pink);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.type-tab.active.inc{background:var(--white);color:var(--teal);box-shadow:0 1px 4px rgba(0,0,0,.1);}

.amount-box{
  background:var(--bg);border-radius:16px;padding:16px 18px;
  margin-bottom:14px;display:flex;align-items:center;gap:8px;
}
.amount-box .curr{font-size:1.4rem;font-weight:800;color:var(--sub);}
.amount-box input{
  flex:1;border:none;background:transparent;outline:none;
  font-size:2rem;font-weight:900;color:var(--text);font-family:inherit;
}
.amount-box input::placeholder{color:#C7C7CC;}

.quick-row{display:flex;flex-wrap:wrap;gap:7px;margin-bottom:14px;}
.q-chip{
  padding:7px 16px;border-radius:20px;
  border:1px solid var(--border);background:var(--white);
  font-size:.82rem;font-weight:600;color:var(--text);cursor:pointer;
  transition:all .2s;
}
.q-chip:hover,.q-chip.sel{background:var(--pink);border-color:var(--pink);color:#fff;}
.q-chip.sel.inc-chip{background:var(--teal);border-color:var(--teal);}

.form-label{font-size:.7rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.06em;margin-bottom:8px;}
.cat-grid2{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:14px;}
.cat-chip2{
  padding:10px 4px;border-radius:14px;border:2px solid var(--border);
  background:var(--white);cursor:pointer;text-align:center;
  transition:all .2s;display:flex;flex-direction:column;align-items:center;gap:3px;
}
.cat-chip2 .cc2-icon{font-size:1.25rem;}
.cat-chip2 .cc2-name{font-size:.6rem;font-weight:600;color:var(--sub);}
.cat-chip2.sel.exp-sel{border-color:var(--pink);background:var(--pink-light);}
.cat-chip2.sel.exp-sel .cc2-name{color:var(--pink);}
.cat-chip2.sel.inc-sel{border-color:var(--teal);background:var(--teal-light);}
.cat-chip2.sel.inc-sel .cc2-name{color:var(--teal);}

.note-field{
  width:100%;padding:12px 14px;
  border:1px solid var(--border);border-radius:12px;
  font-size:.9rem;font-family:inherit;outline:none;
  background:var(--white);color:var(--text);margin-bottom:14px;
  transition:border-color .2s;
}
.note-field:focus{border-color:var(--pink);}

.btn-add{
  width:100%;padding:14px;border:none;border-radius:14px;
  font-size:1rem;font-weight:800;color:#fff;cursor:pointer;
  transition:opacity .2s;letter-spacing:.02em;
}
.btn-add.exp-btn{background:var(--pink);box-shadow:0 4px 14px rgba(255,71,133,.3);}
.btn-add.inc-btn{background:var(--teal);box-shadow:0 4px 14px rgba(0,201,167,.3);}
.btn-add:active{transform:scale(.98);}

/* ‚îÄ‚îÄ ‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö PANEL ‚îÄ‚îÄ */
.budget-header{font-size:1.1rem;font-weight:800;text-align:center;margin-bottom:14px;}
.period-setting-card{
  background:var(--white);border-radius:16px;padding:14px 16px;
  margin-bottom:12px;display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.05);
}
.psc-left .psc-title{font-size:.8rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.05em;}
.psc-left .psc-val{font-size:.9rem;font-weight:600;margin-top:3px;display:flex;align-items:center;gap:5px;}
.btn-small{
  padding:7px 14px;border-radius:10px;border:1px solid var(--border);
  background:var(--white);font-size:.78rem;font-weight:600;cursor:pointer;
  display:flex;align-items:center;gap:4px;
}
.budget-type-tabs{
  display:grid;grid-template-columns:1fr 1fr;gap:0;
  background:var(--bg);border-radius:12px;padding:3px;
  margin-bottom:12px;
}
.btt{
  padding:10px;border:none;border-radius:10px;
  font-size:.88rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.btt.active.exp{background:var(--white);color:var(--pink);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.btt.active.inc{background:var(--white);color:var(--teal);box-shadow:0 1px 4px rgba(0,0,0,.1);}

.budget-list{display:flex;flex-direction:column;gap:8px;}
.budget-item{
  background:var(--white);border-radius:14px;padding:14px 16px;
  display:flex;align-items:center;justify-content:space-between;
  box-shadow:0 1px 4px rgba(0,0,0,.05);cursor:pointer;
  transition:background .2s;
}
.budget-item:hover{background:#fafafa;}
.bi-name{font-size:.92rem;font-weight:600;}
.bi-right{display:flex;align-items:center;gap:8px;}
.bi-budget{font-size:.8rem;color:var(--sub);}
.bi-arrow{color:var(--sub);font-size:.8rem;}

/* Budget modal */
.overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:500;padding:0 0 env(safe-area-inset-bottom);
}
.overlay.hidden{display:none;}
.sheet{
  background:var(--white);border-radius:24px 24px 0 0;
  width:100%;max-width:480px;padding:20px 20px 28px;
}
.sheet-handle{
  width:40px;height:4px;border-radius:2px;
  background:var(--border);margin:0 auto 16px;
}
.sheet-title{font-size:1rem;font-weight:700;margin-bottom:16px;}
.sheet-input{
  width:100%;padding:12px 14px;border:1px solid var(--border);
  border-radius:12px;font-size:1rem;font-family:inherit;
  outline:none;margin-bottom:12px;
  background:var(--bg);color:var(--text);
  transition:border-color .2s;
}
.sheet-input:focus{border-color:var(--pink);}
.sheet-btns{display:flex;gap:10px;}
.sheet-btns button{flex:1;padding:12px;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;}
.btn-sheet-save{background:var(--pink);color:#fff;}
.btn-sheet-save.inc-save{background:var(--teal);}
.btn-sheet-cancel{background:var(--bg);color:var(--sub);}

/* ‚îÄ‚îÄ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ PANEL ‚îÄ‚îÄ */
.filter-row2{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;}
.filter-row2 select,.filter-row2 input[type="month"]{
  padding:8px 12px;border:1px solid var(--border);border-radius:10px;
  font-size:.83rem;background:var(--white);color:var(--text);
  outline:none;font-family:inherit;
}
.tx-list2{display:flex;flex-direction:column;gap:8px;}
.tx2{
  background:var(--white);border-radius:14px;padding:13px 14px;
  display:flex;align-items:center;gap:11px;
  box-shadow:0 1px 4px rgba(0,0,0,.05);
}
.tx2-icon{width:38px;height:38px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0;}
.tx2.expense .tx2-icon{background:var(--pink-light);}
.tx2.income  .tx2-icon{background:var(--teal-light);}
.tx2-info{flex:1;min-width:0;}
.tx2-desc{font-size:.88rem;font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.tx2-meta{font-size:.7rem;color:var(--sub);margin-top:2px;}
.tx2-amt{font-size:.92rem;font-weight:800;flex-shrink:0;}
.tx2.expense .tx2-amt{color:var(--pink);}
.tx2.income  .tx2-amt{color:var(--teal);}
.tx2-del{background:none;border:none;cursor:pointer;color:#DDD;font-size:.9rem;padding:4px;border-radius:6px;transition:color .2s;}
.tx2-del:hover{color:var(--pink);}
.empty2{text-align:center;padding:40px 20px;color:var(--sub);font-size:.9rem;}

/* ‚îÄ‚îÄ ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ PANEL ‚îÄ‚îÄ */
.settings-card{background:var(--white);border-radius:16px;margin-bottom:10px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,.05);}
.settings-card .sc-title{font-size:.7rem;font-weight:700;color:var(--sub);text-transform:uppercase;letter-spacing:.06em;padding:12px 16px 4px;}
.si2{
  display:flex;align-items:center;justify-content:space-between;
  padding:14px 16px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .2s;
}
.si2:last-child{border-bottom:none;}
.si2:hover{background:#fafafa;}
.si2-left .si2-label{font-size:.9rem;font-weight:600;}
.si2-left .si2-sub  {font-size:.72rem;color:var(--sub);margin-top:2px;}
.si2-right{color:var(--sub);font-size:.85rem;}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{
  position:fixed;bottom:calc(var(--nav-h)+16px);left:50%;
  transform:translateX(-50%) translateY(16px);
  background:#1C1C1E;color:#fff;
  padding:10px 20px;border-radius:20px;
  font-size:.85rem;font-weight:600;
  opacity:0;transition:all .3s;z-index:600;
  white-space:nowrap;pointer-events:none;
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ‚îÄ‚îÄ RUNNING DONG ‚îÄ‚îÄ */
#dong-run{
  position:fixed;bottom:calc(var(--nav-h)+8px);left:-70px;
  font-size:2rem;animation:dong-run 16s linear infinite;
  cursor:pointer;z-index:40;pointer-events:auto;
}
@keyframes dong-run{from{left:-70px}to{left:110%}}

/* ‚îÄ‚îÄ HOME BEAR ‚îÄ‚îÄ */
.home-bear-wrap{text-align:center;margin:4px 0 10px;font-size:2.5rem;cursor:pointer;}

/* ‚îÄ‚îÄ CHAT BOX (home) ‚îÄ‚îÄ */
.chat-box{
  background:var(--white);border-radius:16px;padding:14px;
  box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:14px;
}

/* ‚îÄ‚îÄ PIE CHART ‚îÄ‚îÄ */
.pie-section{
  background:var(--white);border-radius:20px;
  padding:16px 16px 14px;margin-bottom:14px;
  box-shadow:0 1px 6px rgba(0,0,0,.07);text-align:center;
}
.pie-filter-row{
  display:flex;gap:4px;justify-content:center;
  margin-bottom:14px;background:var(--bg);
  border-radius:10px;padding:3px;
}
.pie-tab{
  flex:1;padding:8px 12px;border:none;border-radius:8px;
  font-size:.82rem;font-weight:700;cursor:pointer;
  background:transparent;color:var(--sub);transition:all .2s;
}
.pie-tab.active{background:var(--white);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.pie-legend{display:flex;justify-content:center;gap:18px;margin-top:12px;flex-wrap:wrap;}
.pie-legend-item{display:flex;align-items:center;gap:5px;font-size:.78rem;font-weight:600;}
.pie-dot{width:11px;height:11px;border-radius:50%;flex-shrink:0;}

/* ‚îÄ‚îÄ API KEY MODAL ‚îÄ‚îÄ */
.modal-overlay{
  position:fixed;inset:0;background:rgba(0,0,0,.5);
  backdrop-filter:blur(4px);
  display:flex;align-items:flex-end;justify-content:center;
  z-index:600;padding:0 0 env(safe-area-inset-bottom);
}
.modal-overlay.hidden{display:none;}
.modal-sheet{
  background:var(--white);border-radius:24px 24px 0 0;
  width:100%;max-width:480px;padding:20px 20px 28px;
}
.modal-sheet h3{font-size:1rem;font-weight:700;margin-bottom:6px;}
.modal-sheet p{font-size:.78rem;color:var(--sub);margin-bottom:14px;line-height:1.5;}
.modal-btns2{display:flex;gap:10px;margin-top:4px;}
.modal-btns2 button{flex:1;padding:12px;border:none;border-radius:12px;font-size:.9rem;font-weight:700;cursor:pointer;}
.btn-ms-save{background:var(--pink);color:#fff;}
.btn-ms-cancel{background:var(--bg);color:var(--sub);}
.btn-ms-green{background:#00C9A7;color:#fff;}
.gs-step{font-size:.78rem;color:var(--sub);line-height:1.6;margin-bottom:10px;}
.gs-step b{color:var(--text);}
.gs-code{background:#F5F5F5;border-radius:10px;padding:10px 12px;font-size:.7rem;font-family:monospace;color:#333;overflow-x:auto;white-space:pre;margin-bottom:12px;cursor:pointer;border:1px solid var(--border);}
.gs-code-label{font-size:.7rem;color:var(--sub);margin-bottom:4px;}
.sync-status{font-size:.75rem;text-align:center;margin-top:8px;color:var(--sub);}

/* ‚îÄ‚îÄ SPLASH SCREEN ‚îÄ‚îÄ */
#splash{
  position:fixed;inset:0;z-index:9999;
  background:#FF4785;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:16px;
  transition:opacity .5s ease;
}
#splash.hide{opacity:0;pointer-events:none;}
.splash-bear{font-size:72px;animation:splashBounce .7s ease infinite alternate;}
.splash-title{color:#fff;font-size:1.5rem;font-weight:800;letter-spacing:.02em;}
.splash-sub{color:rgba(255,255,255,.75);font-size:.85rem;letter-spacing:.05em;}
@keyframes splashBounce{from{transform:translateY(0);}to{transform:translateY(-10px);}}

/* ‚îÄ‚îÄ INSTALL BANNER ‚îÄ‚îÄ */
#installBanner{
  display:none;
  position:fixed;bottom:calc(var(--nav-h) + 10px);left:12px;right:12px;z-index:800;
  background:#fff;border-radius:16px;
  box-shadow:0 4px 20px rgba(0,0,0,.12);
  padding:14px 16px;
  align-items:center;gap:12px;
  border:1px solid var(--border);
}
#installBanner.show{display:flex;}
.ib-icon{font-size:2rem;flex-shrink:0;}
.ib-text{flex:1;}
.ib-text strong{display:block;font-size:.9rem;font-weight:700;color:var(--text);}
.ib-text span{font-size:.75rem;color:var(--sub);}
.ib-btn{background:var(--pink);color:#fff;border:none;border-radius:10px;padding:8px 14px;font-size:.82rem;font-weight:700;cursor:pointer;white-space:nowrap;}
.ib-close{background:none;border:none;color:var(--sub);font-size:1.2rem;cursor:pointer;padding:4px;flex-shrink:0;}

/* ‚îÄ‚îÄ LINE LOGIN SCREEN ‚îÄ‚îÄ */
#lineLogin{
  position:fixed;inset:0;z-index:10000;
  background:var(--bg);
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  text-align:center;padding:32px;
}
#lineLogin.hidden{display:none;}
.ll-bear{font-size:5rem;margin-bottom:12px;}
.ll-title{font-size:1.4rem;font-weight:900;color:var(--pink);margin-bottom:6px;}
.ll-sub{font-size:.85rem;color:var(--sub);margin-bottom:32px;line-height:1.6;}
.btn-line-login{
  background:#06C755;color:#fff;border:none;
  padding:16px 36px;border-radius:16px;
  font-size:1rem;font-weight:800;cursor:pointer;
  display:flex;align-items:center;gap:10px;
  box-shadow:0 4px 20px rgba(6,199,85,.35);
}
.btn-line-login img{width:24px;height:24px;}
</style>
</head>
<body>

<!-- LINE LOGIN SCREEN -->
<div id="lineLogin" class="hidden">
  <div class="ll-bear">üêº</div>
  <div class="ll-title">ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</div>
  <div class="ll-sub">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE<br>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ú‡∏π‡∏Å‡∏Å‡∏±‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ LINE ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
  <button class="btn-line-login" onclick="liff.login()">
    <img src="https://upload.wikimedia.org/wikipedia/commons/2/2e/LINE_New_App_Icon_%282020-12%29.png" alt="LINE">
    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE
  </button>
</div>

<!-- SPLASH SCREEN -->
<div id="splash">
  <div class="splash-bear">üêº</div>
  <div class="splash-title">ÎèàÎÖ∏Ìä∏ Don Note</div>
  <div class="splash-sub">‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ ‚≠ê</div>
</div>

<!-- INSTALL BANNER (iOS) -->
<div id="installBanner">
  <div class="ib-icon">üêº</div>
  <div class="ib-text">
    <strong>‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏´‡∏•‡∏±‡∏Å</strong>
    <span>‡πÅ‡∏ï‡∏∞ ‚¨° ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"</span>
  </div>
  <button class="ib-close" onclick="dismissInstall()">‚úï</button>
</div>

<!-- HEADER -->
<div class="header">
  <div class="header-bear" id="headerBear">üêº</div>
  <div class="header-title">ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</div>
  <div class="header-right" id="headerRight"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏™‡∏£‡∏∏‡∏õ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel active" id="panel-home">

  <div class="balance-wrap">
    <div class="balance-label">‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏Å‡πá‡∏ö</div>
    <div class="balance-amount" id="balAmount">‡∏ø0</div>
    <button class="period-btn" onclick="cyclePeriod()">
      <span id="periodLabel">‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡∏ô‡∏µ‡πâ</span>
      <span>‚áÑ</span>
    </button>
  </div>

  <!-- Bear center home -->
  <div class="home-bear-wrap" id="homeBear" onclick="runDong()">üêº</div>

  <!-- Quick type box (moved here from ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å panel) -->
  <div class="chat-box">
    <div class="form-label" style="margin-bottom:8px;">‚ö° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡∏≤‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å 65"</div>
    <div style="display:flex;gap:8px;">
      <input class="note-field" id="chatIn" placeholder="‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß 80 / ‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô 25000" style="margin:0;flex:1;min-width:0;" inputmode="text" autocomplete="off">
      <button onclick="parseChat()" style="padding:0 18px;border:none;border-radius:12px;background:var(--pink);color:#fff;font-weight:700;cursor:pointer;white-space:nowrap;font-size:.88rem;flex-shrink:0;">‚û§</button>
    </div>
  </div>

  <div class="ie-grid">
    <div class="ie-card exp-card active" id="ieExp" onclick="switchSumTab('expense')">
      <div class="iec-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div class="iec-amount" id="ieExpAmt">‡∏ø0.00</div>
    </div>
    <div class="ie-card inc-card" id="ieInc" onclick="switchSumTab('income')">
      <div class="iec-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
      <div class="iec-amount" id="ieIncAmt">‡∏ø0.00</div>
    </div>
  </div>

  <!-- Pie chart -->
  <div class="pie-section">
    <div class="pie-filter-row">
      <button class="pie-tab active" id="pieTabDay"   onclick="setPiePeriod('day')">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</button>
      <button class="pie-tab"        id="pieTabMonth" onclick="setPiePeriod('month')">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</button>
    </div>
    <canvas id="pieChart" width="180" height="180" style="max-width:180px;"></canvas>
    <div class="pie-legend" id="pieLegend"></div>
  </div>

  <div class="sum-card">
    <div class="sum-card-header">
      <div class="dong-badge">Don<br>Note</div>
      <div class="sum-card-title exp-title" id="sumCardTitle">‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div style="width:44px;"></div>
    </div>
    <div id="catRows"></div>
    <button class="btn-manage" onclick="goPanel('panel-budget')">
      ‚úèÔ∏è ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏á‡∏ö
    </button>
    <button class="invite-banner">
      ‡∏ä‡∏ß‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô
      <span class="invite-badge">Don Note Pro</span>
      ‡∏£‡∏±‡∏ö‡∏ü‡∏£‡∏µ 1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
    </button>
  </div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-add">

  <div class="add-header">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>

  <!-- Type -->
  <div class="type-tabs">
    <button class="type-tab exp active" id="tabExp" onclick="setAddType('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="type-tab inc"        id="tabInc" onclick="setAddType('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
  </div>

  <!-- Amount -->
  <div class="amount-box">
    <span class="curr">‡∏ø</span>
    <input type="number" id="inputAmt" placeholder="0" inputmode="decimal" min="0">
  </div>

  <!-- Quick amounts -->
  <div class="quick-row" id="quickRow">
    <div class="q-chip" onclick="setAmt(30)">30</div>
    <div class="q-chip" onclick="setAmt(50)">50</div>
    <div class="q-chip" onclick="setAmt(65)">65</div>
    <div class="q-chip" onclick="setAmt(100)">100</div>
    <div class="q-chip" onclick="setAmt(200)">200</div>
    <div class="q-chip" onclick="setAmt(500)">500</div>
    <div class="q-chip" onclick="setAmt(1000)">1,000</div>
  </div>

  <!-- Category -->
  <div class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</div>
  <div class="cat-grid2" id="catGrid2"></div>

  <!-- Note -->
  <input class="note-field" id="noteField" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">

  <!-- Submit -->
  <button class="btn-add exp-btn" id="btnAdd" onclick="addEntry()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å ‚úì</button>


</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-budget">

  <div class="budget-header">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏°‡∏ß‡∏î‡πÅ‡∏•‡∏∞‡∏á‡∏ö</div>

  <div class="period-setting-card">
    <div class="psc-left">
      <div class="psc-title">‡∏£‡∏≠‡∏ö‡∏ï‡∏±‡∏î‡∏á‡∏ö</div>
      <div class="psc-val">üìÖ ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà 1)</div>
    </div>
    <button class="btn-small">‚úèÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
  </div>

  <div class="budget-type-tabs">
    <button class="btt exp active" id="bttExp" onclick="switchBudgetTab('expense')">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</button>
    <button class="btt inc"        id="bttInc" onclick="switchBudgetTab('income')">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</button>
  </div>

  <div class="budget-list" id="budgetList"></div>

</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-history">
  <div class="filter-row2">
    <input type="month" id="filterMonth" onchange="renderHistory()">
    <select id="filterType" onchange="renderHistory()">
      <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
      <option value="expense">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
      <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
    </select>
  </div>
  <div class="tx-list2" id="txList2"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL: ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="panel" id="panel-settings">
  <div style="text-align:center;padding:20px 0 16px;">
    <img id="linePicDisplay" src="" alt="" style="display:none;width:72px;height:72px;border-radius:50%;object-fit:cover;margin-bottom:10px;border:3px solid var(--pink);">
    <div id="settingsBear" style="font-size:3.5rem;cursor:pointer;" onclick="runDong()">üêº</div>
    <div style="font-size:1rem;font-weight:700;margin-top:6px;" id="lineNameDisplay">ÎèàÎÖ∏Ìä∏ Don Note ‚≠ê</div>
    <div style="font-size:.75rem;color:var(--sub);margin-top:2px;">v2.0 ¬∑ ‡πÇ‡∏ô‡πâ‡∏ï‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡πÑ‡∏ï‡∏•‡πå‡πÄ‡∏Å‡∏≤‡∏´‡∏•‡∏µ</div>
  </div>
  <div class="settings-card">
    <div class="sc-title">‚òÅÔ∏è Cloud Sync</div>
    <div class="si2">
      <div class="si2-left"><div class="si2-label">‚òÅÔ∏è ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Firebase</div><div class="si2-sub" id="cloudStatusSub">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</div></div>
    </div>
    <div class="si2" onclick="lineLogout()" style="cursor:pointer;">
      <div class="si2-left"><div class="si2-label" style="color:#06C755;">üü¢ LINE Account</div><div class="si2-sub">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
  </div>
  <div class="settings-card">
    <div class="sc-title">Google Sheet</div>
    <div class="si2" onclick="openSheetModal()">
      <div class="si2-left"><div class="si2-label">üìä ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheet</div><div class="si2-sub" id="sheetUrlSub">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
    <div class="si2" onclick="syncToSheet()">
      <div class="si2-left"><div class="si2-label">üîÑ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Sheet</div><div class="si2-sub" id="syncStatusSub">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
  </div>
  <div class="settings-card">
    <div class="sc-title">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
    <div class="si2" onclick="clearData()">
      <div class="si2-left"><div class="si2-label" style="color:var(--pink);">üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="si2-sub">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡πÑ‡∏î‡πâ</div></div>
      <div class="si2-right">‚Ä∫</div>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ BOTTOM NAV ‚îÄ‚îÄ -->
<nav class="bottom-nav">
  <button class="nav-btn active" id="nav-home"     onclick="goPanel('panel-home')">    <span class="ni">üè†</span>‡∏™‡∏£‡∏∏‡∏õ</button>
  <button class="nav-btn"        id="nav-add"      onclick="goPanel('panel-add')">     <span class="ni">‚úèÔ∏è</span>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  <button class="nav-btn"        id="nav-budget"   onclick="goPanel('panel-budget')">  <span class="ni">ü•ß</span>‡∏´‡∏°‡∏ß‡∏î/‡∏á‡∏ö</button>
  <button class="nav-btn"        id="nav-history"  onclick="goPanel('panel-history')"> <span class="ni">üìã</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  <button class="nav-btn"        id="nav-settings" onclick="goPanel('panel-settings')"><span class="ni">‚öôÔ∏è</span>‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤</button>
</nav>

<!-- Google Sheet modal -->
<div class="modal-overlay hidden" id="gsModal">
  <div class="modal-sheet" style="max-height:85vh;overflow-y:auto;">
    <div class="sheet-handle"></div>
    <h3>üìä ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Google Sheet</h3>
    <div class="gs-step">
      <b>‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô:</b><br>
      1. ‡πÄ‡∏õ‡∏¥‡∏î Google Sheet ‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì<br>
      2. ‡πÄ‡∏°‡∏ô‡∏π <b>Extensions ‚Üí Apps Script</b><br>
      3. ‡∏•‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡πÄ‡∏î‡∏¥‡∏° ‚Üí ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á ‚Üí Save<br>
      4. <b>Deploy ‚Üí New deployment ‚Üí Web app</b><br>
      5. Execute as: <b>Me</b> ¬∑ Access: <b>Anyone</b><br>
      6. Copy URL ‡∏°‡∏≤‡πÉ‡∏™‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á
    </div>
    <div class="gs-code-label">üìã ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å Apps Script:</div>
    <div class="gs-code" id="gsCodeBlock" onclick="copyGsCode()">function doPost(e){
  try{
    var d=JSON.parse(e.postData.contents);
    var ss=SpreadsheetApp.getActiveSpreadsheet();
    var sh=ss.getSheetByName('DonNote')||ss.insertSheet('DonNote');
    if(sh.getLastRow()===0) sh.appendRow(['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó','‡∏´‡∏°‡∏ß‡∏î','‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏']);
    if(d.action==='sync'){
      if(sh.getLastRow()>1) sh.deleteRows(2,sh.getLastRow()-1);
      d.entries.forEach(function(r){
        sh.appendRow([r.date,r.type==='expense'?'‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢':'‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',r.catName,r.catIcon,r.amount,r.note]);
      });
    }
    return ContentService.createTextOutput(JSON.stringify({status:'ok'})).setMimeType(ContentService.MimeType.JSON);
  }catch(err){
    return ContentService.createTextOutput(JSON.stringify({status:'error',msg:err.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}
function doGet(){return ContentService.createTextOutput(JSON.stringify({status:'ok'})).setMimeType(ContentService.MimeType.JSON);}</div>
    <input class="sheet-input" id="gsUrlInput" placeholder="https://script.google.com/macros/s/..." style="font-size:.78rem;">
    <div class="sync-status" id="gsTestStatus"></div>
    <div class="modal-btns2" style="margin-top:10px;">
      <button class="btn-ms-cancel" onclick="closeSheetModal()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-ms-green" onclick="testAndSaveSheet()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Budget sheet -->
<div class="overlay hidden" id="budgetSheet">
  <div class="sheet">
    <div class="sheet-handle"></div>
    <div class="sheet-title" id="sheetTitle">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏´‡∏°‡∏ß‡∏î</div>
    <div style="font-size:.78rem;color:var(--sub);margin-bottom:10px;">‡πÉ‡∏™‡πà 0 ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö</div>
    <input class="sheet-input" type="number" id="sheetInput" placeholder="0" inputmode="decimal">
    <div class="sheet-btns">
      <button class="btn-sheet-cancel" onclick="closeSheet()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button class="btn-sheet-save" id="btnSheetSave" onclick="saveBudget()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
    </div>
  </div>
</div>

<!-- Running dong -->
<div id="dong-run">üêº</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FIREBASE SETUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const firebaseConfig = {
  apiKey: "AIzaSyAOAr6OsQpf_e-xv8qfLyIUu6Dant1MkS4",
  authDomain: "don-note.firebaseapp.com",
  projectId: "don-note",
  storageBucket: "don-note.firebasestorage.app",
  messagingSenderId: "661381674055",
  appId: "1:661381674055:web:0427dc17348fb11b56ed62"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LIFF + LINE LOGIN ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const LIFF_ID = '2009230946-hp9vcPh3';
let userId = null;
let lineProfile = null;

async function initLiff() {
  try {
    await liff.init({ liffId: LIFF_ID });
    if (liff.isLoggedIn()) {
      lineProfile = await liff.getProfile();
      userId = lineProfile.userId;
      document.getElementById('lineLogin').classList.add('hidden');
      updateLineProfileUI();
      init();
    } else {
      // ‡πÄ‡∏õ‡∏¥‡∏î‡∏ô‡∏≠‡∏Å LINE app ‚Üí ‡πÉ‡∏ä‡πâ local userId ‡πÅ‡∏ó‡∏ô
      useFallbackUserId();
    }
  } catch(e) {
    console.error('LIFF init error:', e);
    // LIFF ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‚Üí ‡πÉ‡∏ä‡πâ local userId ‡πÅ‡∏ó‡∏ô ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö login
    useFallbackUserId();
  }
}

function useFallbackUserId() {
  let localId = localStorage.getItem('dong_local_uid');
  if (!localId) {
    localId = 'local_' + Math.random().toString(36).slice(2, 10);
    localStorage.setItem('dong_local_uid', localId);
  }
  userId = localId;
  document.getElementById('lineLogin').classList.add('hidden');
  init();
}

function updateLineProfileUI() {
  if (!lineProfile) return;
  // Header
  const hb = document.getElementById('headerBear');
  if (hb && lineProfile.pictureUrl) {
    hb.innerHTML = `<img src="${lineProfile.pictureUrl}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;">`;
  }
  // Settings
  const nameEl = document.getElementById('lineNameDisplay');
  if (nameEl) nameEl.textContent = lineProfile.displayName;
  const picEl = document.getElementById('linePicDisplay');
  if (picEl && lineProfile.pictureUrl) {
    picEl.src = lineProfile.pictureUrl;
    picEl.style.display = 'block';
  }
}
async function initLiff() {
  try {
    // 1. ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏ö‡∏ö LINE
    await liff.init({ liffId: LIFF_ID });

    if (liff.isLoggedIn()) {
      // 2. ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß -> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß
      lineProfile = await liff.getProfile();
      userId = lineProfile.userId; 

      // 3. ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠ UI
      document.getElementById('lineLogin').classList.add('hidden');
      updateLineProfileUI();
      
      // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡∏≤‡∏Å Firebase (‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ userId ‡∏à‡∏≤‡∏Å LINE)
      init(); 
    } else {
      // 5. ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö -> ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏õ‡∏∏‡πà‡∏° Login
      document.getElementById('lineLogin').classList.remove('hidden');
      // ‡∏õ‡∏¥‡∏î Splash Screen ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏î‡πâ
      const sp = document.getElementById('splash');
      if (sp) sp.classList.add('hide');
    }
  } catch (e) {
    console.error('LIFF Error:', e);
    // ‡∏´‡∏≤‡∏Å‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô Browser ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏£‡∏∞‡∏ö‡∏ö ID ‡∏™‡∏≥‡∏£‡∏≠‡∏á (Local)
    useFallbackUserId();
  }
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ
function updateLineProfileUI() {
  if (!lineProfile) return;
  
  // ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà Header
  const hb = document.getElementById('headerBear');
  if (hb && lineProfile.pictureUrl) {
    hb.innerHTML = `<img src="${lineProfile.pictureUrl}" style="width:32px;height:32px;border-radius:50%;object-fit:cover;border:1.5px solid #FF4785;">`;
  }
  
  // ‡πÉ‡∏™‡πà‡∏£‡∏π‡∏õ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ (Settings)
  const nameEl = document.getElementById('lineNameDisplay');
  const picEl = document.getElementById('linePicDisplay');
  if (nameEl) nameEl.textContent = lineProfile.displayName;
  if (picEl && lineProfile.pictureUrl) {
    picEl.src = lineProfile.pictureUrl;
    picEl.style.display = 'block';
  }
}



async function saveToCloud() {
  try {
    await db.collection('dongNote').doc(userId).set({
      entries: entries,
      budgets: budgets,
      updatedAt: new Date().toISOString()
    });
    updateCloudStatus('‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß');
  } catch(e) {
    updateCloudStatus('‚ö†Ô∏è ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');
  }
}

async function loadFromCloud() {
  try {
    const doc = await db.collection('dongNote').doc(userId).get();
    if (doc.exists) {
      const data = doc.data();
      if (data.entries) { entries = data.entries; localStorage.setItem('dong_entries', JSON.stringify(entries)); }
      if (data.budgets) { budgets = data.budgets; localStorage.setItem('dong_budgets', JSON.stringify(budgets)); }
    } else if (entries.length > 0 || Object.keys(budgets).length > 0) {
      await saveToCloud(); return;
    }
    updateCloudStatus('‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß');
  } catch(e) {
    updateCloudStatus('‚ö†Ô∏è ‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á');
  }
}

function updateCloudStatus(msg) {
  const el = document.getElementById('cloudStatusSub');
  if (el) el.textContent = msg;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CONSTANTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const EXP_CATS = [
  {id:'food',    icon:'üçú', name:'‡∏≠‡∏≤‡∏´‡∏≤‡∏£'},
  {id:'drink',   icon:'üßã', name:'‡∏Å‡∏≤‡πÅ‡∏ü'},
  {id:'deliver', icon:'üõµ', name:'‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ'},
  {id:'travel',  icon:'üöå', name:'‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á'},
  {id:'place',   icon:'üè†', name:'‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å'},
  {id:'shop',    icon:'üõçÔ∏è', name:'‡∏ä‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á'},
  {id:'beauty',  icon:'üíÑ', name:'‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏°'},
  {id:'health',  icon:'üíä', name:'‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û'},
  {id:'phone',   icon:'üì±', name:'‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå'},
  {id:'net',     icon:'üì∂', name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï'},
  {id:'sub',     icon:'üé¨', name:'Subscription'},
  {id:'other',   icon:'üì¶', name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'},
];
const INC_CATS = [
  {id:'salary',   icon:'üíº', name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô'},
  {id:'special',  icon:'‚≠ê', name:'‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©'},
  {id:'freelance',icon:'üíª', name:'‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå'},
  {id:'sell',     icon:'üè∑Ô∏è', name:'‡∏Ç‡∏≤‡∏¢‡∏Ç‡∏≠‡∏á'},
  {id:'invest',   icon:'üìà', name:'‡∏•‡∏á‡∏ó‡∏∏‡∏ô'},
  {id:'gift',     icon:'üéÅ', name:'‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç'},
  {id:'other_i',  icon:'üí∞', name:'‡∏≠‡∏∑‡πà‡∏ô‡πÜ'},
];
const INC_COLORS = {
  salary:'#34C759', special:'#00C9A7', freelance:'#007AFF',
  sell:'#FF9500', invest:'#AF52DE', gift:'#FF2D55', other_i:'#8E8E93'
};
const TH_MS = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let entries  = JSON.parse(localStorage.getItem('dong_entries') || '[]');
let budgets  = JSON.parse(localStorage.getItem('dong_budgets') || '{}'); // {catId: amount}
let addType  = 'expense';
let selCatId = 'food';
let sumTab   = 'expense';
let budgetTab= 'expense';
let editCatId= null;
let barTmrs  = [];
let piePeriod= 'month';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GOOGLE SHEET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gsUrl = localStorage.getItem('dong_gs_url') || '';

function updateSheetSubLabel(){
  const sub = document.getElementById('sheetUrlSub');
  if(!sub) return;
  sub.textContent = gsUrl ? '‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ¬∑ ‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°';
}

function openSheetModal(){
  document.getElementById('gsUrlInput').value = gsUrl;
  document.getElementById('gsTestStatus').textContent = '';
  document.getElementById('gsModal').classList.remove('hidden');
}
function closeSheetModal(){ document.getElementById('gsModal').classList.add('hidden'); }

function copyGsCode(){
  const code = document.getElementById('gsCodeBlock').textContent;
  navigator.clipboard?.writeText(code).then(()=>showToast('üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡πÅ‡∏•‡πâ‡∏ß!')).catch(()=>{});
}

async function testAndSaveSheet(){
  const url = document.getElementById('gsUrlInput').value.trim();
  if(!url){ showToast('‡πÉ‡∏™‡πà URL ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞'); return; }
  const st = document.getElementById('gsTestStatus');
  st.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏î‡∏™‡∏≠‡∏ö...';
  try{
    const r = await fetch(url, {method:'GET', mode:'no-cors'});
    gsUrl = url;
    localStorage.setItem('dong_gs_url', url);
    updateSheetSubLabel();
    st.textContent = '';
    closeSheetModal();
    showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å URL ‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏î "‡∏ã‡∏¥‡∏á‡∏Ñ‡πå" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
  }catch(e){
    st.textContent = '‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à URL ‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á';
  }
}

async function syncToSheet(){
  if(!gsUrl){ showToast('‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Google Sheet URL ‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞‡∏Ñ‡∏∞'); openSheetModal(); return; }
  const sub = document.getElementById('syncStatusSub');
  if(sub) sub.textContent = '‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...';
  try{
    await fetch(gsUrl, {
      method: 'POST',
      mode: 'no-cors',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({action:'sync', entries})
    });
    const now = new Date().toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
    if(sub) sub.textContent = `‚úÖ ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß ${now}`;
    showToast(`üìä ‡∏™‡πà‡∏á ${entries.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏õ Sheet ‡πÅ‡∏•‡πâ‡∏ß!`);
  }catch(e){
    if(sub) sub.textContent = '‚ùå ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à';
    showToast('‚ùå ‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á');
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init(){
  document.getElementById('filterMonth').value = todayYM();
  renderCatGrid2();
  renderAll();
  renderBudgetList();
  initDong();
  renderPieChart();
  updateSheetSubLabel();
  updateLineProfileUI();
  updateCloudStatus('‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ã‡∏¥‡∏á‡∏Ñ‡πå...');
  // chatIn Enter key + iPhone scroll fix
  const ci=document.getElementById('chatIn');
  if(ci){
    ci.addEventListener('keydown',e=>{ if(e.key==='Enter') parseChat(); });
    ci.addEventListener('focus',()=>{ setTimeout(()=>ci.scrollIntoView({behavior:'smooth',block:'center'}),300); });
  }
  // Load from cloud then re-render
  loadFromCloud().then(()=>{ renderAll(); renderBudgetList(); });
}

function todayStr(){ return new Date().toISOString().slice(0,10); }
function todayYM() { return new Date().toISOString().slice(0,7); }
function fmtDate(d){
  const[y,m,day]=d.split('-');
  return parseInt(day)+' '+TH_MS[parseInt(m)-1]+' '+(parseInt(y)+543);
}
function fmt(n){ return Number(n).toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2}); }
function fmt0(n){ return Number(n).toLocaleString('th-TH',{minimumFractionDigits:0,maximumFractionDigits:0}); }
function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PANEL NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function goPanel(id){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  const key=id.replace('panel-','');
  const nb=document.getElementById('nav-'+key);
  if(nb) nb.classList.add('active');
  if(id==='panel-history') renderHistory();
  if(id==='panel-budget') renderBudgetList();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PERIOD (simple: this month) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function cyclePeriod(){
  showToast('üêº ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡∏á‡∏ö‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏°‡∏≤‡πÄ‡∏£‡πá‡∏ß‡πÜ ‡∏ô‡∏µ‡πâ!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUMMARY TAB ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchSumTab(tab){
  sumTab=tab;
  document.getElementById('ieExp').classList.toggle('active',tab==='expense');
  document.getElementById('ieInc').classList.toggle('active',tab==='income');
  document.getElementById('sumCardTitle').className='sum-card-title '+(tab==='expense'?'exp-title':'inc-title');
  document.getElementById('sumCardTitle').textContent=tab==='expense'?'‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢':'‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö';
  renderCatRows();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê RENDER ALL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderAll(){
  const ym=todayYM();
  const md=entries.filter(e=>e.date.startsWith(ym));
  const inc=md.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const exp=md.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const bal=inc-exp;

  document.getElementById('ieIncAmt').textContent='‡∏ø'+fmt(inc);
  document.getElementById('ieExpAmt').textContent='‡∏ø'+fmt(exp);
  const el=document.getElementById('balAmount');
  el.textContent=(bal<0?'-':'')+'‡∏ø'+fmt(Math.abs(bal));
  el.className='balance-amount '+(bal<0?'negative':bal>0?'positive':'');

  // period label
  const now=new Date();
  const [y,m]=ym.split('-');
  document.getElementById('periodLabel').textContent=
    '1 '+TH_MS[parseInt(m)-1]+' - '+new Date(now.getFullYear(),now.getMonth()+1,0).getDate()+' '+TH_MS[parseInt(m)-1]+' '+(parseInt(y)+543);

  renderCatRows();
  renderPieChart();
}

let barTmrs2=[];
function renderCatRows(){
  barTmrs2.forEach(clearTimeout); barTmrs2=[];
  const ym=todayYM();
  const md=entries.filter(e=>e.date.startsWith(ym)&&e.type===sumTab);
  const catMap={};
  md.forEach(e=>{ catMap[e.catId]=(catMap[e.catId]||0)+e.amount; });
  const total=Object.values(catMap).reduce((s,v)=>s+v,0);

  const cats=sumTab==='expense'?EXP_CATS:INC_CATS;
  const isExp=sumTab==='expense';

  document.getElementById('catRows').innerHTML=cats.map((c,i)=>{
    const amt=catMap[c.id]||0;
    const bgt=budgets[c.id]||0;
    const amtStr='‡∏ø'+fmt0(amt);
    const bgtStr=bgt>0?'‡∏ø'+fmt0(bgt):'-';
    const pct=bgt>0?Math.min(100,(amt/bgt)*100):(total>0?Math.min(100,(amt/total)*100):0);
    const trackCls=isExp?'exp-track':'inc-track';
    const fillStyle=isExp?'background:var(--pink);':'background:'+(INC_COLORS[c.id]||'var(--teal)')+';';
    return `<div class="cat-row">
      <div class="cat-row-top">
        <span class="cat-row-name">${c.name}</span>
        <span class="cat-row-amt">${amtStr} / ${bgtStr}</span>
      </div>
      <div class="bar-track ${trackCls}">
        <div class="bar-fill" id="cbf_${i}" style="width:0%;${fillStyle}"></div>
      </div>
    </div>`;
  }).join('');

  cats.forEach((_,i)=>{
    const c=cats[i];
    const amt=catMap[c.id]||0;
    const bgt=budgets[c.id]||0;
    const pct=bgt>0?Math.min(100,(amt/bgt)*100):(total>0?Math.min(100,(amt/total)*100):0);
    const t=setTimeout(()=>{ const el=document.getElementById('cbf_'+i); if(el)el.style.width=pct+'%'; },60+i*40);
    barTmrs2.push(t);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ADD ENTRY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setAddType(type){
  addType=type;
  document.getElementById('tabExp').classList.toggle('active',type==='expense');
  document.getElementById('tabInc').classList.toggle('active',type==='income');
  document.getElementById('tabExp').classList.toggle('exp',type==='expense');
  document.getElementById('tabInc').classList.toggle('inc',type==='income');
  document.getElementById('btnAdd').className='btn-add '+(type==='expense'?'exp-btn':'inc-btn');
  selCatId=type==='expense'?'food':'salary';
  renderCatGrid2();
  // update chip colors
  document.querySelectorAll('.q-chip').forEach(c=>{
    c.classList.toggle('inc-chip',type==='income');
  });
}

function renderCatGrid2(){
  const cats=addType==='expense'?EXP_CATS:INC_CATS;
  const selCls=addType==='expense'?'exp-sel':'inc-sel';
  document.getElementById('catGrid2').innerHTML=cats.map(c=>`
    <div class="cat-chip2 ${selCatId===c.id?'sel '+selCls:''}" onclick="selCat2('${c.id}')">
      <div class="cc2-icon">${c.icon}</div>
      <div class="cc2-name">${c.name}</div>
    </div>`).join('');
}

function selCat2(id){ selCatId=id; renderCatGrid2(); }

function setAmt(v){
  document.getElementById('inputAmt').value=v;
  document.querySelectorAll('.q-chip').forEach(c=>c.classList.toggle('sel',c.textContent.replace(',','')==v));
}

function addEntry(){
  const amt=parseFloat(document.getElementById('inputAmt').value);
  if(!amt||amt<=0){ showToast('‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ üêº'); return; }
  const note=document.getElementById('noteField').value.trim();
  const allCats=[...EXP_CATS,...INC_CATS];
  const cat=allCats.find(c=>c.id===selCatId)||allCats[0];
  entries.push({id:Date.now(),type:addType,amount:amt,catId:cat.id,catIcon:cat.icon,catName:cat.name,note:note||cat.name,date:todayStr()});
  save(); renderAll();
  document.getElementById('inputAmt').value='';
  document.getElementById('noteField').value='';
  document.querySelectorAll('.q-chip').forEach(c=>c.classList.remove('sel'));
  showToast(addType==='expense'?`‚ù§Ô∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß`:`üíö ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÅ‡∏•‡πâ‡∏ß`);
  goPanel('panel-home');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PARSE CHAT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function guessCategory(t){
  // ‚îÄ‚îÄ‚îÄ INCOME ‚îÄ‚îÄ‚îÄ
  if(/‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô|salary|‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô/.test(t))                                        return {catId:'salary',   type:'income'};
  if(/‡∏ü‡∏£‡∏µ‡πÅ‡∏•‡∏ô‡∏ã‡πå|freelance|‡∏á‡∏≤‡∏ô‡∏ü‡∏£‡∏µ|free.?lance/.test(t))                               return {catId:'freelance', type:'income'};
  if(/‡∏•‡∏á‡∏ó‡∏∏‡∏ô|invest|‡∏õ‡∏±‡∏ô‡∏ú‡∏•|dividend|‡∏Å‡∏≥‡πÑ‡∏£|profit|‡∏´‡∏∏‡πâ‡∏ô|stock|crypto|‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï/.test(t))    return {catId:'invest',    type:'income'};
  if(/‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç|‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Ç‡∏≠‡∏á|gift|present|‡πÅ‡∏°‡πà‡πÉ‡∏´‡πâ|‡∏û‡πà‡∏≠‡πÉ‡∏´‡πâ|‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ/.test(t))                  return {catId:'gift',      type:'income'};
  if(/‡∏Ç‡∏≤‡∏¢/.test(t))                                                                   return {catId:'sell',      type:'income'};
  if(/‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô|‡πÑ‡∏î‡πâ‡πÄ‡∏á‡∏¥‡∏ô|‡πÇ‡∏ö‡∏ô‡∏±‡∏™|bonus|‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ|‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©|part.?time|‡∏û‡∏≤‡∏£‡πå‡∏ó‡πÑ‡∏ó‡∏°‡πå|‡∏Ñ‡πà‡∏≤‡∏à‡πâ‡∏≤‡∏á|‡∏Ñ‡πà‡∏≤‡∏ï‡∏≠‡∏ö‡πÅ‡∏ó‡∏ô|commission|‡∏Ñ‡∏≠‡∏°/.test(t)) return {catId:'special', type:'income'};

  // ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏° (‡∏Å‡πà‡∏≠‡∏ô food ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ overlap) ‚îÄ‚îÄ‚îÄ
  if(/‡∏ä‡∏≤‡∏ô‡∏°|‡πÑ‡∏Ç‡πà‡∏°‡∏∏‡∏Å|boba|bubble.?tea|‡∏ä‡∏≤‡πÑ‡∏ó‡∏¢|‡∏ä‡∏≤‡πÄ‡∏¢‡πá‡∏ô|‡∏ä‡∏≤‡∏£‡πâ‡∏≠‡∏ô|‡∏ä‡∏≤‡∏°‡∏∞‡∏ô‡∏≤‡∏ß|‡∏ä‡∏≤‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß|‡∏°‡∏±‡∏ó‡∏â‡∏∞|matcha|‡πÇ‡∏Å‡πÇ‡∏Å‡πâ|cocoa|‡πÇ‡∏≠‡∏ß‡∏±‡∏•‡∏ï‡∏¥‡∏ô/.test(t)) return {catId:'drink', type:'expense'};
  if(/‡∏Å‡∏≤‡πÅ‡∏ü|coffee|cafe|‡∏Ñ‡∏≤‡πÄ‡∏ü‡πà|espresso|latte|‡∏•‡∏≤‡πÄ‡∏ï‡πâ|‡∏Ñ‡∏≤‡∏õ‡∏π‡∏ä‡∏¥‡πÇ‡∏ô|americano|‡∏≠‡πÄ‡∏°‡∏£‡∏¥‡∏Å‡∏≤‡πÇ‡∏ô|starbucks|‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ö‡∏±‡∏Ñ|amazon\s*cafe|‡∏≠‡πÄ‡∏°‡∏ã‡∏≠‡∏ô\s*cafe|‡∏î‡∏£‡∏¥‡∏õ|drip|cold.?brew|‡πÇ‡∏Ñ‡∏•‡∏î‡πå‡∏ö‡∏£‡∏π/.test(t)) return {catId:'drink', type:'expense'};
  if(/‡∏ô‡πâ‡∏≥(?:‡∏ú‡∏•‡πÑ‡∏°‡πâ|‡∏õ‡∏±‡πà‡∏ô|‡∏°‡∏∞‡∏û‡∏£‡πâ‡∏≤‡∏ß|‡∏≠‡πâ‡∏≠‡∏¢)|smoothie|‡∏™‡∏°‡∏π‡∏ó‡∏ï‡∏µ‡πâ|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏î‡∏∑‡πà‡∏°|‡∏ä‡∏≤(?!‡πÄ‡∏¢‡πá‡∏ô|‡∏£‡πâ‡∏≠‡∏ô)/.test(t)) return {catId:'drink', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ (‡∏Å‡πà‡∏≠‡∏ô food ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ overlap) ‚îÄ‚îÄ‚îÄ
  if(/grabfood|grab\s*food|foodpanda|panda|lineman|line\s*man|shopeefood|shopee\s*food|robinhood|‡πÄ‡∏î‡∏•‡∏¥‡πÄ‡∏ß‡∏≠‡∏£‡∏µ|delivery|‡∏™‡πà‡∏á\s*‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏™‡∏±‡πà‡∏á\s*‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏™‡∏±‡πà‡∏á\s*‡∏Å‡∏¥‡∏ô/.test(t)) return {catId:'deliver', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ‚îÄ‚îÄ‚îÄ
  if(/‡∏Ç‡πâ‡∏≤‡∏ß|‡∏≠‡∏≤‡∏´‡∏≤‡∏£|‡∏Å‡∏¥‡∏ô|‡∏ó‡∏≤‡∏ô|‡∏°‡∏∑‡πâ‡∏≠(?:‡πÄ‡∏ä‡πâ‡∏≤|‡∏Å‡∏•‡∏≤‡∏á|‡πÄ‡∏¢‡πá‡∏ô)|‡πÄ‡∏ä‡πâ‡∏≤|‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô|‡πÄ‡∏¢‡πá‡∏ô|‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß|‡∏ú‡∏±‡∏î|‡∏ï‡πâ‡∏°|‡πÅ‡∏Å‡∏á|‡∏¢‡∏≥|‡∏™‡πâ‡∏°‡∏ï‡∏≥|‡∏•‡∏≤‡∏ö|‡∏´‡∏°‡∏π|‡πÑ‡∏Å‡πà|‡∏õ‡∏•‡∏≤|‡∏Å‡∏∏‡πâ‡∏á|‡∏´‡∏≠‡∏¢|‡πÄ‡∏ô‡∏∑‡πâ‡∏≠|pizza|‡∏û‡∏¥‡∏ã‡∏ã‡πà‡∏≤|sushi|‡∏ã‡∏π‡∏ä‡∏¥|‡∏£‡∏≤‡πÄ‡∏°‡πá‡∏á|ramen|‡∏™‡πÄ‡∏ï‡πá‡∏Å|steak|burger|‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÄ‡∏Å‡∏≠‡∏£‡πå|kfc|mcdonald|‡∏ä‡∏≤‡∏ö‡∏π|‡∏´‡∏°‡∏≤‡∏•‡πà‡∏≤|hotpot|shabu|‡∏ö‡∏∏‡∏ü‡πÄ‡∏ü‡πà|buffet|‡∏Ç‡πâ‡∏≤‡∏ß‡∏°‡∏±‡∏ô|‡∏Ç‡πâ‡∏≤‡∏ß‡∏ï‡πâ‡∏°|‡πÇ‡∏à‡πä‡∏Å|‡∏Å‡πã‡∏ß‡∏¢‡∏à‡∏±‡πä‡∏ö|‡∏Ç‡∏ô‡∏°|‡πÄ‡∏ö‡πÄ‡∏Å‡∏≠‡∏£‡∏µ‡πà|bakery|‡πÄ‡∏Ñ‡πâ‡∏Å|cake|cookie|‡∏Ñ‡∏∏‡∏Å‡∏Å‡∏µ‡πâ|‡πÑ‡∏≠‡∏®‡∏Ñ‡∏£‡∏µ‡∏°|‡πÑ‡∏≠‡∏ï‡∏¥‡∏°|ice.?cream|dessert|‡∏Ç‡∏≠‡∏á‡∏´‡∏ß‡∏≤‡∏ô|‡∏Å‡πã‡∏ß‡∏¢‡πÄ‡∏ï‡∏µ‡πã‡∏¢‡∏ß|‡∏Å‡πã‡∏ß‡∏¢‡∏à‡∏±‡πä‡∏ö|‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà|‡πÑ‡∏Å‡πà‡∏ó‡∏≠‡∏î|‡∏ã‡∏µ‡∏ü‡∏π‡πâ‡∏î|‡∏õ‡∏¥‡πâ‡∏á‡∏¢‡πà‡∏≤‡∏á/.test(t)) return {catId:'food', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á ‚îÄ‚îÄ‚îÄ
  if(/bts|mrt|‡∏£‡∏ñ‡πÑ‡∏ü|‡∏£‡∏ñ‡πÄ‡∏°‡∏•‡πå|‡∏£‡∏ñ‡∏ï‡∏π‡πâ|‡∏™‡∏≠‡∏á‡πÅ‡∏ñ‡∏ß|‡πÅ‡∏ó‡πá‡∏Å‡∏ã‡∏µ‡πà|taxi|grab\s*car|grabcar|bolt|uber|‡∏ß‡∏¥‡∏ô‡∏°‡∏≠|‡∏°‡∏≠‡πÑ‡∏ã‡∏Ñ‡πå‡∏£‡∏±‡∏ö‡∏à‡πâ‡∏≤‡∏á|‡∏ó‡∏≤‡∏á‡∏î‡πà‡∏ß‡∏ô|toll|expressway|‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô|‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô|petrol|gasoline|‡∏õ‡∏ï‡∏ó|‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å|‡πÄ‡∏ä‡∏•‡∏•‡πå|shell|esso|‡∏ï‡∏±‡πã‡∏ß|flight|‡∏ö‡∏¥‡∏ô|air(?:port|asia|line)|‡∏™‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ö‡∏¥‡∏ô|‡∏™‡∏ô‡∏≤‡∏°‡∏ö‡∏¥‡∏ô|‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á|‡∏£‡∏ñ‡∏ó‡∏±‡∏ß‡∏£‡πå|van/.test(t)) return {catId:'travel', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å ‚îÄ‚îÄ‚îÄ
  if(/‡∏Ñ‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á|‡∏Ñ‡πà‡∏≤‡πÄ‡∏ä‡πà‡∏≤|‡πÄ‡∏ä‡πà‡∏≤‡∏´‡πâ‡∏≠‡∏á|‡πÄ‡∏ä‡πà‡∏≤‡∏ö‡πâ‡∏≤‡∏ô|‡∏ó‡∏µ‡πà‡∏û‡∏±‡∏Å|‡∏´‡∏≠‡∏û‡∏±‡∏Å|‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î|condo|apartment|‡∏Ñ‡πà‡∏≤‡πÑ‡∏ü|‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥|‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á|‡∏Ñ‡πà‡∏≤‡πÅ‡∏Å‡πä‡∏™|‡πÇ‡∏£‡∏á‡πÅ‡∏£‡∏°|hotel|hostel/.test(t)) return {catId:'place', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ Subscription ‚îÄ‚îÄ‚îÄ
  if(/netflix|nflx|spotify|youtube.?premium|apple.?music|apple.?tv|disney.?\+|disneyplus|hbo|prime.?video|amazon.?prime|icloud|google.?one|canva|adobe|notion|chatgpt|claude|subscription|membership/.test(t)) return {catId:'sub', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï ‚îÄ‚îÄ‚îÄ
  if(/‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï(?!‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)|internet|wifi|wi-fi|‡πÑ‡∏ß‡πÑ‡∏ü|broadband|fiber|‡πÄ‡∏ô‡πá‡∏ï‡∏ö‡πâ‡∏≤‡∏ô/.test(t)) return {catId:'net', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå ‚îÄ‚îÄ‚îÄ
  if(/‡∏Ñ‡πà‡∏≤‡πÇ‡∏ó‡∏£|‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏ô‡πá‡∏ï|‡πÄ‡∏ï‡∏¥‡∏°‡πÄ‡∏á‡∏¥‡∏ô|dtac|ais|true.?move|‡∏ó‡∏£‡∏π‡∏°‡∏π‡∏ü|‡∏ã‡∏¥‡∏°/.test(t)) return {catId:'phone', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏á‡∏≤‡∏° ‚îÄ‚îÄ‚îÄ
  if(/‡∏Ñ‡∏£‡∏µ‡∏°|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏≠‡∏≤‡∏á|makeup|lipstick|‡∏•‡∏¥‡∏õ|‡∏ö‡∏•‡∏±‡∏ä|‡πÅ‡∏õ‡πâ‡∏á|foundation|serum|‡πÄ‡∏ã‡∏£‡∏±‡πà‡∏°|‡∏™‡∏Å‡∏¥‡∏ô‡πÅ‡∏Ñ‡∏£‡πå|skincare|‡∏ó‡∏≥‡∏ú‡∏°|‡∏ï‡∏±‡∏î‡∏ú‡∏°|‡∏¢‡πâ‡∏≠‡∏°‡∏ú‡∏°|‡∏ó‡∏≥‡πÄ‡∏•‡πá‡∏ö|‡πÄ‡∏•‡πá‡∏ö|nail|‡∏™‡∏õ‡∏≤|spa|‡∏ô‡∏ß‡∏î|massage|facial|wax|‡πÅ‡∏ß‡πá‡∏Å‡∏ã‡πå|gym|fitness|‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á/.test(t)) return {catId:'beauty', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û ‚îÄ‚îÄ‚îÄ
  if(/‡∏´‡∏°‡∏≠|‡∏¢‡∏≤|‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•|‡πÇ‡∏£‡∏á‡∏ö‡∏≤‡∏•|hospital|‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Å|clinic|‡∏â‡∏µ‡∏î‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô|‡∏ß‡∏±‡∏Ñ‡∏ã‡∏µ‡∏ô|vaccine|‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏™‡∏£‡∏¥‡∏°|supplement|‡∏ß‡∏¥‡∏ï‡∏≤‡∏°‡∏¥‡∏ô|vitamin|‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û|‡∏ó‡∏≥‡∏ü‡∏±‡∏ô|‡∏à‡∏±‡∏Å‡∏©‡∏∏|‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û/.test(t)) return {catId:'health', type:'expense'};

  // ‚îÄ‚îÄ‚îÄ ‡∏ä‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á ‚îÄ‚îÄ‚îÄ
  if(/‡∏ã‡∏∑‡πâ‡∏≠|‡∏ä‡πâ‡∏≠‡∏õ|‡∏ä‡∏≠‡∏õ|shopee|lazada|temu|‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤|‡∏Å‡∏≤‡∏á‡πÄ‡∏Å‡∏á|‡πÄ‡∏™‡∏∑‡πâ‡∏≠|‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤|‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤|‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ|‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏ä‡πâ|‡πÄ‡∏ü‡∏≠‡∏£‡πå‡∏ô‡∏¥‡πÄ‡∏à‡∏≠‡∏£‡πå|ikea|central|paragon|terminal|the.?mall|‡πÄ‡∏ã‡πá‡∏ô‡∏ó‡∏£‡∏±‡∏•|‡∏°‡∏≤‡∏ö‡∏∏‡∏ç‡∏Ñ‡∏£‡∏≠‡∏á|mbk|‡∏û‡∏±‡∏ô‡∏ó‡∏¥‡∏õ|jib|banana|it/.test(t)) return {catId:'shop', type:'expense'};

  return {catId:'other', type:'expense'};
}

function parseChat(){
  const text=document.getElementById('chatIn').value.trim();
  if(!text){showToast('‡∏û‡∏¥‡∏°‡∏û‡πå‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏∞ ‚≠ê');return;}
  const amt=parseFloat((text.match(/[\d,]+(\.\d+)?/)||[])[0]?.replace(/,/g,''));
  if(!amt){showToast('ÎèàÎÖ∏Ìä∏ ‡∏´‡∏≤‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠ ‚≠ê');return;}

  const t=text.toLowerCase();

  // ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏≠‡∏¢‡∏π‡πà category ‡πÑ‡∏´‡∏ô ‡πÉ‡∏ä‡πâ category ‡∏ô‡∏±‡πâ‡∏ô
  const textWords=t.replace(/[\d,\.]+/g,'').trim().split(/\s+/).filter(w=>w.length>1);
  let learned=null;
  if(textWords.length>0){
    const recent=[...entries].reverse().slice(0,60);
    for(const e of recent){
      const en=e.note.toLowerCase();
      if(textWords.some(w=>w.length>2&&en.includes(w))){
        learned={catId:e.catId,type:e.type};
        break;
      }
    }
  }

  const guessed=guessCategory(t);
  const {catId,type}=(learned&&guessed.catId==='other')?learned:guessed;

  const allCats=[...EXP_CATS,...INC_CATS];
  const cat=allCats.find(c=>c.id===catId)||allCats[0];
  entries.push({id:Date.now(),type,amount:amt,catId:cat.id,catIcon:cat.icon,catName:cat.name,note:text,date:todayStr()});
  save(); renderAll();
  const ci=document.getElementById('chatIn');
  ci.value='';
  ci.blur();
  setTimeout(()=>window.scrollTo({top:0,behavior:'smooth'}),100);
  showToast(`${cat.icon} "${cat.name}" ‡∏ø${fmt0(amt)} ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!`);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUDGET ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchBudgetTab(tab){
  budgetTab=tab;
  document.getElementById('bttExp').classList.toggle('active',tab==='expense');
  document.getElementById('bttInc').classList.toggle('active',tab==='income');
  document.getElementById('bttExp').classList.toggle('exp',tab==='expense');
  document.getElementById('bttInc').classList.toggle('inc',tab==='income');
  renderBudgetList();
}

function renderBudgetList(){
  const cats=budgetTab==='expense'?EXP_CATS:INC_CATS;
  document.getElementById('budgetList').innerHTML=cats.map(c=>{
    const b=budgets[c.id];
    const bStr=b>0?'‡∏ø'+fmt0(b):'‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö';
    return `<div class="budget-item" onclick="openSheet('${c.id}','${c.name}')">
      <span class="bi-name">${c.name}</span>
      <div class="bi-right">
        <span class="bi-budget">‡∏á‡∏ö ${bStr}</span>
        <span class="bi-arrow">‚Ä∫</span>
      </div>
    </div>`;
  }).join('');
}

function openSheet(catId,catName){
  editCatId=catId;
  document.getElementById('sheetTitle').textContent='‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö "'+catName+'"';
  document.getElementById('sheetInput').value=budgets[catId]>0?budgets[catId]:'';
  document.getElementById('btnSheetSave').className='btn-sheet-save '+(budgetTab==='income'?'inc-save':'');
  document.getElementById('budgetSheet').classList.remove('hidden');
}
function closeSheet(){ document.getElementById('budgetSheet').classList.add('hidden'); }
function saveBudget(){
  const v=parseFloat(document.getElementById('sheetInput').value)||0;
  if(v>0) budgets[editCatId]=v;
  else delete budgets[editCatId];
  localStorage.setItem('dong_budgets',JSON.stringify(budgets));
  saveToCloud();
  closeSheet(); renderBudgetList(); renderCatRows();
  showToast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HISTORY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHistory(){
  const ym=document.getElementById('filterMonth').value;
  const ft=document.getElementById('filterType').value;
  let data=entries.filter(e=>e.date.startsWith(ym));
  if(ft!=='all') data=data.filter(e=>e.type===ft);
  data.sort((a,b)=>b.date.localeCompare(a.date)||b.id-a.id);
  const c=document.getElementById('txList2');
  if(!data.length){c.innerHTML=`<div class="empty2">üêº<br><br>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏¢‡∏ô‡∏∞</div>`;return;}
  c.innerHTML=data.map(e=>`
    <div class="tx2 ${e.type}">
      <div class="tx2-icon">${e.catIcon||'üí∞'}</div>
      <div class="tx2-info">
        <div class="tx2-desc">${esc(e.note)}</div>
        <div class="tx2-meta">${e.catName} ¬∑ ${fmtDate(e.date)}</div>
      </div>
      <div class="tx2-amt">${e.type==='income'?'+':'-'}‡∏ø${fmt0(e.amount)}</div>
      <button class="tx2-del" onclick="delEntry(${e.id})">üóëÔ∏è</button>
    </div>`).join('');
}

function delEntry(id){
  entries=entries.filter(e=>e.id!==id);
  save(); renderAll(); renderHistory();
  showToast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function clearData(){
  if(!confirm('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÑ‡∏´‡∏°?'))return;
  entries=[];budgets={};save();renderAll();showToast('üóëÔ∏è ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PIE CHART ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setPiePeriod(p){
  piePeriod=p;
  document.getElementById('pieTabDay').classList.toggle('active',p==='day');
  document.getElementById('pieTabMonth').classList.toggle('active',p==='month');
  renderPieChart();
}

function renderPieChart(){
  const filter=piePeriod==='day'?todayStr():todayYM();
  const data=entries.filter(e=>e.date.startsWith(filter));
  const inc=data.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const exp=data.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  const total=inc+exp;

  const canvas=document.getElementById('pieChart');
  if(!canvas) return;
  const ctx=canvas.getContext('2d');
  const cx=canvas.width/2, cy=canvas.height/2;
  const r=Math.min(cx,cy)-8;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  if(total===0){
    ctx.beginPath();ctx.arc(cx,cy,r,0,Math.PI*2);ctx.fillStyle='#E5E5EA';ctx.fill();
    ctx.beginPath();ctx.arc(cx,cy,r*0.55,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    ctx.fillStyle='#8E8E93';ctx.font='bold 12px -apple-system';
    ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',cx,cy);
  } else {
    const expAngle=(exp/total)*Math.PI*2;
    const incAngle=(inc/total)*Math.PI*2;
    const start=-Math.PI/2;
    // Expense slice
    if(exp>0){
      ctx.beginPath();ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start,start+expAngle);
      ctx.closePath();ctx.fillStyle='#FF4785';ctx.fill();
    }
    // Income slice
    if(inc>0){
      ctx.beginPath();ctx.moveTo(cx,cy);
      ctx.arc(cx,cy,r,start+expAngle,start+expAngle+incAngle);
      ctx.closePath();ctx.fillStyle='#00C9A7';ctx.fill();
    }
    // Donut hole
    ctx.beginPath();ctx.arc(cx,cy,r*0.56,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();
    // Center label
    ctx.fillStyle='#1C1C1E';ctx.font='bold 13px -apple-system';
    ctx.textAlign='center';ctx.textBaseline='middle';
    ctx.fillText('‡∏ø'+fmt0(total),cx,cy);
  }

  // Legend
  document.getElementById('pieLegend').innerHTML=`
    <div class="pie-legend-item">
      <div class="pie-dot" style="background:#FF4785;"></div>
      <span>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ‡∏ø${fmt0(exp)}</span>
    </div>
    <div class="pie-legend-item">
      <div class="pie-dot" style="background:#00C9A7;"></div>
      <span>‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ‡∏ø${fmt0(inc)}</span>
    </div>
  `;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DONG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initDong(){
  const h=new Date().getHours();
  const emoji=h<6?'üêº‚Äç‚ùÑÔ∏è':h<12?'üêº‚Äç‚ùÑÔ∏è':h<18?'üêº':h<22?'üêº':'üêº';
  document.getElementById('dong-run').textContent=emoji;
  document.getElementById('headerBear').textContent=emoji;
  document.getElementById('settingsBear').textContent=emoji;
  document.getElementById('homeBear').textContent=emoji;
  document.getElementById('dong-run').onclick=()=>{
    const msgs=['ÎèàÎÖ∏Ìä∏: ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏∑‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡πâ‡∏ß‡∏¢‡∏ô‡∏∞! ‚≠ê','ÎèàÎÖ∏Ìä∏: ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å üí∞','ÎèàÎÖ∏Ìä∏: ‡∏£‡∏±‡∏Å‡∏ô‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏•‡∏¢ ‚≠êüíï'];
    showToast(msgs[Math.floor(Math.random()*msgs.length)]);
  };
}
function runDong(){
  document.getElementById('dong-run').style.animation='none';
  setTimeout(()=>{ document.getElementById('dong-run').style.animation='dong-run 6s linear'; },10);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HELPERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save(){ localStorage.setItem('dong_entries',JSON.stringify(entries)); saveToCloud(); }
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2500);
}

initLiff();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SPLASH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.addEventListener('load', () => {
  const sp = document.getElementById('splash');
  setTimeout(() => {
    sp.classList.add('hide');
    setTimeout(() => sp.remove(), 520);
  }, 1400);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê INSTALL BANNER (iOS) ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isInStandalone() {
  return window.navigator.standalone === true ||
         window.matchMedia('(display-mode: standalone)').matches;
}
function dismissInstall() {
  document.getElementById('installBanner').classList.remove('show');
  localStorage.setItem('installDismissed', '1');
}
(function checkInstall() {
  const isIOS = /iphone|ipad|ipod/i.test(navigator.userAgent);
  if (!isInStandalone() && isIOS && !localStorage.getItem('installDismissed')) {
    setTimeout(() => {
      document.getElementById('installBanner').classList.add('show');
    }, 3000);
  }
})();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SERVICE WORKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js').catch(() => {});
}
</script>
</body>
</html>



‡πÄ‡∏£‡∏≤‡∏´‡∏≤‡πÑ‡∏°‡πà‡πÄ‡∏à‡∏≠‡∏Ç‡∏≠‡∏ó‡∏±‡πâ‡∏á‡∏Å‡πâ‡∏≠‡∏ô‡πÅ‡∏Å‡πâ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡πà‡∏∞